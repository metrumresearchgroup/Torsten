<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-06-28 Mon 13:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Torsten: A Pharmacokinetic/Pharmacodynamic Model Library for Stan</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Yi Zhang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" href="tufte.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Torsten: A Pharmacokinetic/Pharmacodynamic Model Library for Stan
<br />
<span class="subtitle">User's Guide  <br> (Torsten Version 0.89rc, Stan version 2.27.0)</span>
</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgca853d0">Development team</a></li>
<li><a href="#org0a59558">Acknowledgements</a>
<ul>
<li><a href="#orge8ff462">Institutions</a></li>
<li><a href="#org8179b57">Funding</a>
<ul>
<li><a href="#org413f87c">Office of Naval Research (ONR) contract N00014-16-P-2039</a></li>
<li><a href="#orge436acd">Bill &amp; Melinda Gates Foundation.</a></li>
</ul>
</li>
<li><a href="#org4ecd3c3">Individuals</a></li>
</ul>
</li>
<li><a href="#orgd7ea273">1. Introduction</a>
<ul>
<li><a href="#org460c1ef">1.1. Overview</a></li>
<li><a href="#org4b826c8">1.2. Implementation summary</a></li>
<li><a href="#org190fb33">1.3. Development plans</a></li>
<li><a href="#org156ed93">1.4. Changelog</a>
<ul>
<li><a href="#orgd26dc38">1.4.1. Version 0.89 <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-15 Tue&gt;</span></span></a></li>
<li><a href="#org942674e">1.4.2. Version 0.88 <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-12-18 Fri&gt;</span></span></a></li>
<li><a href="#orgfafd051">1.4.3. Version 0.87 <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-07-26 Fri&gt;</span></span></a></li>
<li><a href="#org26032a4">1.4.4. Version 0.86 <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-05-15 Wed&gt;</span></span></a></li>
<li><a href="#org71de615">1.4.5. Version 0.85 <span class="timestamp-wrapper"><span class="timestamp">&lt;2018-12-04 Tue&gt;</span></span></a></li>
<li><a href="#orga50acf5">1.4.6. Version 0.84 <span class="timestamp-wrapper"><span class="timestamp">&lt;2018-02-24 Sat&gt;</span></span></a></li>
<li><a href="#org696e5e6">1.4.7. Version 0.83 <span class="timestamp-wrapper"><span class="timestamp">&lt;2017-08-02 Wed&gt;</span></span></a></li>
<li><a href="#0-82-added">1.4.8. Version 0.82 <span class="timestamp-wrapper"><span class="timestamp">&lt;2017-01-29 Sun&gt;</span></span></a></li>
<li><a href="#orgdbc8ed2">1.4.9. Version 0.81 <span class="timestamp-wrapper"><span class="timestamp">&lt;2016-09-27 Tue&gt;</span></span></a></li>
<li><a href="#org99c4000">1.4.10. Version 0.80a <span class="timestamp-wrapper"><span class="timestamp">&lt;2016-09-21 Wed&gt;</span></span></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf18b586">2. Installation</a>
<ul>
<li><a href="#orgaae5862">2.1. Command line interface</a></li>
<li><a href="#org31b9e7a">2.2. R interface</a></li>
<li><a href="#orgd460284">2.3. MPI support</a></li>
<li><a href="#org6468ec1">2.4. Testing</a></li>
</ul>
</li>
<li><a href="#orgc437d9b">3. Using Torsten</a>
<ul>
<li><a href="#org218a6ac">3.1. One Compartment Model</a>
<ul>
<li><a href="#org82ef22e">3.1.1. Description</a></li>
<li><a href="#org8daa289">3.1.2. Usage</a></li>
<li><a href="#org5a0a754">3.1.3. Arguments</a></li>
<li><a href="#org6db00b7">3.1.4. Return value</a></li>
<li><a href="#org2fe3795">3.1.5. Note</a></li>
</ul>
</li>
<li><a href="#org61ca17d">3.2. Two Compartment Model</a>
<ul>
<li><a href="#org073fcdc">3.2.1. Description</a></li>
<li><a href="#org188a088">3.2.2. Usage</a></li>
<li><a href="#orgd64ca22">3.2.3. Arguments</a></li>
<li><a href="#org8447a4f">3.2.4. Return value</a></li>
<li><a href="#org38fd650">3.2.5. Note</a></li>
</ul>
</li>
<li><a href="#org9769dac">3.3. General Linear ODE Model Function</a>
<ul>
<li><a href="#orgbe184c2">3.3.1. Description</a></li>
<li><a href="#org21770f9">3.3.2. Usage</a></li>
<li><a href="#org170ac34">3.3.3. Arguments</a></li>
<li><a href="#org994e5ca">3.3.4. Return value</a></li>
</ul>
</li>
<li><a href="#org1d7de98">3.4. General ODE Model Function</a>
<ul>
<li><a href="#org1a2012a">3.4.1. Description</a></li>
<li><a href="#orgcdede8e">3.4.2. Usage</a></li>
<li><a href="#org5759fca">3.4.3. Arguments</a></li>
<li><a href="#org2e4b2de">3.4.4. Return value</a></li>
<li><a href="#orged5aee8">3.4.5. Note</a></li>
</ul>
</li>
<li><a href="#orged731ab">3.5. Coupled ODE Model Function</a>
<ul>
<li><a href="#org784f68d">3.5.1. Description</a></li>
<li><a href="#orgfea8cee">3.5.2. Usage</a></li>
<li><a href="#org808a5e6">3.5.3. Arguments</a></li>
<li><a href="#org2b99bf0">3.5.4. Return value</a></li>
</ul>
</li>
<li><a href="#orgf1b3b9a">3.6. General ODE-based Population Model Function</a>
<ul>
<li><a href="#org5dfabc2">3.6.1. Description</a></li>
<li><a href="#org267c0cd">3.6.2. Usage</a></li>
<li><a href="#org2715b0a">3.6.3. Arguments</a></li>
<li><a href="#org1895b10">3.6.4. Return value</a></li>
<li><a href="#org26403a1">3.6.5. Note</a></li>
</ul>
</li>
<li><a href="#org009a587">3.7. ODE  integrator Function</a>
<ul>
<li><a href="#org2517b1a">3.7.1. Description</a></li>
<li><a href="#org254de19">3.7.2. Usage</a></li>
<li><a href="#orgb0cfa71">3.7.3. Arguments</a></li>
<li><a href="#org098adf3">3.7.4. Return value</a></li>
<li><a href="#org83c6b22">3.7.5. Note</a></li>
</ul>
</li>
<li><a href="#org310372d">3.8. ODE group  integrator Function</a>
<ul>
<li><a href="#org307a44f">3.8.1. Description</a></li>
<li><a href="#orgf877b3f">3.8.2. Usage</a></li>
<li><a href="#org3e1e0f0">3.8.3. Return value</a></li>
<li><a href="#orgc5b1246">3.8.4. Note</a></li>
</ul>
</li>
<li><a href="#org72a8ba7">3.9. Univariate integral</a></li>
<li><a href="#orgcb349cc">3.10. Piecewise linear interpolation</a></li>
</ul>
</li>
<li><a href="#orgff30706">4. Examples</a>
<ul>
<li><a href="#org9bfc9f9">4.1. Two-compartment model for single patient</a></li>
<li><a href="#org3056f65">4.2. Two-compartment model as a linear ODE model for single patient</a></li>
<li><a href="#org682173d">4.3. Two-compartment model solved by numerical integrator for single patient</a></li>
<li><a href="#org57966d8">4.4. Joint PK-PD model</a></li>
<li><a href="#orgbd36df0">4.5. Two-compartment population model</a></li>
<li><a href="#orgc3994c9">4.6. Lotka-Volterra group model</a></li>
<li><a href="#orgfd2f3d0">4.7. Univariate integral of a quadratic function</a></li>
<li><a href="#org7b4fdff">4.8. Linear intepolation</a></li>
<li><a href="#org46d998d">4.9. Effect Compartment Population Model</a>
<ul>
<li><a href="#orgc8b5e5e">4.9.1. Population Model for Plasma Drug Concentration \(c\)</a></li>
<li><a href="#org2d3af3d">4.9.2. Effect Compartment Model for PD response \(R\).</a></li>
<li><a href="#org5b7998e">4.9.3. Results</a></li>
</ul>
</li>
<li><a href="#orgfd06df0">4.10. Friberg-Karlsson Semi-Mechanistic Population Model</a>
<ul>
<li><a href="#orgd18220a">4.10.1. Friberg-Karlsson Population Model for drug-induced myelosuppression (\(ANC\))</a></li>
<li><a href="#org70a070d">4.10.2. Results</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd7f7fe7">Compiling constants</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgca853d0" class="outline-2">
<h2 id="orgca853d0">Development team</h2>
<div class="outline-text-2" id="text-orgca853d0">
<ul class="org-ul">
<li><a href="mailto:billg@metrumrg.com">William R. Gillespie</a> , <a href="https://www.metrumrg.com/">Metrum Research Group</a></li>
<li><a href="mailto:yiz@metrumrg.com">Yi Zhang</a> , <a href="https://www.metrumrg.com/">Metrum Research Group</a></li>
<li><a href="mailto:charles.margossian@columbia.edu">Charles Margossian</a> , Columbia University, Department of Statistics</li>
</ul>
</div>
</div>
<div id="outline-container-org0a59558" class="outline-2">
<h2 id="org0a59558">Acknowledgements</h2>
<div class="outline-text-2" id="text-org0a59558">
</div>
<div id="outline-container-orge8ff462" class="outline-3">
<h3 id="orge8ff462">Institutions</h3>
<div class="outline-text-3" id="text-orge8ff462">
<p>
We thank Metrum Research Group, Columbia University, and AstraZeneca.
</p>
</div>
</div>
<div id="outline-container-org8179b57" class="outline-3">
<h3 id="org8179b57">Funding</h3>
<div class="outline-text-3" id="text-org8179b57">
<p>
This work was funded in part by the following organizations:
</p>
</div>
<div id="outline-container-org413f87c" class="outline-4">
<h4 id="org413f87c">Office of Naval Research (ONR) contract N00014-16-P-2039</h4>
<div class="outline-text-4" id="text-org413f87c">
<p>
provided as part of the Small Business Technology Transfer (STTR)
program. The content of the information presented in this document
does not necessarily reflect the position or policy of the
Government and no official endorsement should be inferred.
</p>
</div>
</div>
<div id="outline-container-orge436acd" class="outline-4">
<h4 id="orge436acd">Bill &amp; Melinda Gates Foundation.</h4>
</div>
</div>
<div id="outline-container-org4ecd3c3" class="outline-3">
<h3 id="org4ecd3c3">Individuals</h3>
<div class="outline-text-3" id="text-org4ecd3c3">
<p>
We thank the Stan Development Team for giving us guidance on how to
create new Stan functions and adding features to Stan's core language
that facilitate building ODE-based models.
</p>

<p>
We also thank Kyle Baron and Hunter Ford for helpful advice on coding
in C++ and using GitHub, Curtis Johnston for reviewing the User
Manual, and Yaming Su for using Torsten and giving us feedback.
</p>
</div>
</div>
</div>
<div id="outline-container-orgd7ea273" class="outline-2">
<h2 id="orgd7ea273"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Stan is an open source probabilistic programing language designed
primarily to do Bayesian data analysis
(<a href="#citeproc_bib_item_3">Carpenter et al. 2017</a>). Several of its
features make it a powerful tool to specify and fit complex
models. First, its language is very expressive and
flexible. Secondly, it implements a variant of No U-Turn
Sampler(NUTS), an adaptative Hamiltonian Monte Carlo
algorithm that was proven more efficient than commonly used Monte Carlo Markov Chains
(MCMC) samplers for complex high dimensional problems (<a href="#citeproc_bib_item_7">Hoffman and Gelman 2011</a>; <a href="#citeproc_bib_item_2">Betancourt 2018</a>). Our
goal is to harness these innovations and make Stan a better
software for pharmacometrics modeling. Our efforts are twofold:
</p>
<ol class="org-ol">
<li>We contribute to the development of features, such as functions that support differential equations based models, and implement them directly into Stan's core language.</li>
<li>We develop Torsten, an extension with specialized pharmacometrics functions.</li>
</ol>

<p>
Throughout the process, we work very closely with the Stan Development
Team. We have benefited immensely from their mentorship, advice, and
feedback. Just like Stan, Torsten is an open source project that
fosters collaborative work. Interested in contributing?
Comment at Torsten repository
</p>

<p>
<a href="https://github.com/metrumresearchgroup/Torsten">https://github.com/metrumresearchgroup/Torsten</a> 
</p>

<p>
or email us (<a href="mailto:billg@metrumrg.com">billg@metrumrg.com</a>, <a href="mailto:yz@yizh.org">yiz@metrumrg.com</a>) and we will help you help us!
</p>

<p>
Torsten is licensed under the BSD 3-clause license.
</p>

<div class="mdframed">
<p>
<b>WARNING:</b> The current version of Torsten is a <i>prototype</i>. It
is being released for review and comment, and to support limited
research applications. It has not been rigorously tested and should
not be used for critical applications without further testing or
cross-checking by comparison with other methods.
</p>

<p>
We encourage interested users to try Torsten out and are happy to
assist. Please report issues, bugs, and feature requests on
<a href="https://github.com/metrumresearchgroup/stan">our GitHub page</a>.
</p>

</div>
</div>

<div id="outline-container-org460c1ef" class="outline-3">
<h3 id="org460c1ef"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Torsten is a collection of Stan functions to facilitate analysis of
pharmacometric data using Stan. The current version
includes:
</p>
<ul class="org-ul">
<li>Specific linear compartment models:
<ul class="org-ul">
<li>One compartment model with first order absorption.</li>
<li>Two compartment model with elimination from and first order absorption into central compartment</li>
</ul></li>
<li>General linear compartment model described by a system of first-order \underline{linear} Ordinary Differential Equations (ODEs).</li>
<li>General compartment model described by a system of first order ODEs.</li>
<li>Mix compartment model with PK forcing function described by a linear one or two compartment model.</li>
</ul>

<p>
The models and data format are based on
NONMEM\textregistered{}<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>/NMTRAN/PREDPP
conventions including:
</p>
<ul class="org-ul">
<li>Recursive calculation of model predictions
<ul class="org-ul">
<li>This permits piecewise constant covariate values</li>
</ul></li>
<li>Bolus or constant rate inputs into any compartment</li>
<li>Single dose and multiple dose events</li>
<li>Handles steady state dosing events</li>
<li>Implemented NMTRAN data items include: TIME, EVID, CMT, AMT, RATE, ADDL, II, SS</li>
</ul>

<p>
In general, all real variables may be passed as model parameters. A
few exceptions apply /to functions which use a numerical
integrator(i.e. the general and the mix compartment
models). The below listed cases present technical difficulties, which we expect to
overcome in Torsten's next release:
</p>
<ul class="org-ul">
<li>In the case of a multiple truncated infusion rate dosing regimen:
<ul class="org-ul">
<li>The bioavailability (F) and the amount (AMT) must be fixed.</li>
</ul></li>
</ul>

<p>
This library provides Stan language functions that calculate amounts
in each compartment, given an event schedule and an ODE system.
</p>
</div>
</div>

<div id="outline-container-org4b826c8" class="outline-3">
<h3 id="org4b826c8"><span class="section-number-3">1.2</span> Implementation summary</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Current Torsten v0.89rc is based on Stan v2.27.0.</li>
<li>All functions are programmed in C++ and are compatible
with the Stan math automatic differentiation library (<a href="#citeproc_bib_item_4">Carpenter et al. 2015</a>)</li>
<li>One and two compartment models are based on analytical solutions of governing ODEs.</li>
<li>General linear compartment models are based on semi-analytical solutions using the built-in matrix exponential function</li>
<li>General compartment models are solved numerically using built-in ODE integrators in Stan. The tuning parameters of the solver are adjustable. The steady state solution is calculated using a numerical algebraic solver.</li>
<li>A mix compartment model's PK forcing function is solved analytically, and its forced ODE system is solved numerically.</li>
</ul>
</div>
</div>

<div id="outline-container-org190fb33" class="outline-3">
<h3 id="org190fb33"><span class="section-number-3">1.3</span> Development plans</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Our current plans for future development of Torsten include the
following:
</p>
<ul class="org-ul">
<li>Build a system to easily share packages of Stan functions
(written in C++ or in the Stan language)</li>
<li>Optimize Matrix exponential functions
<ul class="org-ul">
<li>Function for the action of Matrix Exponential on a vector</li>
<li>Hand-coded gradients</li>
<li>Special algorithm for matrices with special properties</li>
</ul></li>
<li>Develop new method for large-scale hierarchical models with costly
ODE solving.</li>
<li>Fix issue that arises when computing the adjoint of the lag time
parameter (in a dosing compartment) evaluated at \(t_{\text{lag}} = 0\).</li>
<li>Extend formal tests
<ul class="org-ul">
<li>More unit tests and better CD/CI support.</li>
<li>Comparison with simulations from the R package
<code>mrgsolve</code> and the software NONMEM\textregistered{}</li>
<li>Recruit non-developer users to conduct beta testing</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org156ed93" class="outline-3">
<h3 id="org156ed93"><span class="section-number-3">1.4</span> Changelog</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-orgd26dc38" class="outline-4">
<h4 id="orgd26dc38"><span class="section-number-4">1.4.1</span> Version 0.89 <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-06-15 Tue&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-1">
</div>
<ul class="org-ul">
<li><a id="0-85-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-85-changed">
<ul class="org-ul">
<li>New backend for ODE events solvers.</li>
<li>Use vector instead of array as ODE function state &amp; return type.</li>
<li>Simplified ODE integrator naming,
e.g. <code>pmx_ode_bdf</code> and  <code>pmx_ode_bdf_ctrl</code>.</li>
<li>Update to Stan version 2.27.0.</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org942674e" class="outline-4">
<h4 id="org942674e"><span class="section-number-4">1.4.2</span> Version 0.88 <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-12-18 Fri&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-2">
</div>
<ul class="org-ul">
<li><a id="0-85-added"></a>Added<br />
<div class="outline-text-5" id="text-0-85-added">
<ul class="org-ul">
<li>Bioavailability, lag time, ODE real &amp; integer data are optional in PMX function signatures.</li>
<li>Support all EVID options from NM-TRAN and mrgsolve.</li>
<li>Support steady-state infusion through multiple interdose intervals.</li>
</ul>
</div>
</li>
<li><a id="0-85-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-85-changed">
<ul class="org-ul">
<li>More efficient memory management of COVDES implenmentation.</li>
<li>Update of MPI framework to adapt multilevel paralleism.</li>
<li>Update to Stan version 2.25.0.</li>
<li>Use cmdstanr as R interface.</li>
<li>Stop supporting rstan as R interface.</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgfafd051" class="outline-4">
<h4 id="orgfafd051"><span class="section-number-4">1.4.3</span> Version 0.87 <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-07-26 Fri&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-3">
</div>
<ul class="org-ul">
<li><a id="0-85-added"></a>Added<br />
<div class="outline-text-5" id="text-0-85-added">
<ul class="org-ul">
<li><p>
MPI dynamic load balance for Torsten's population ODE integrators
</p>
<ul class="org-ul">
<li><code class="src src-stan">pmx_integrate_ode_group_adams</code></li>
<li><code class="src src-stan">pmx_integrate_ode_group_bdf</code></li>
<li><code class="src src-stan">pmx_integrate_ode_group_rk45</code></li>
</ul>
<p>
To invoke dynamic load balance instead of default static
balance for MPI, issue <code>TORSTEN_MPI=2</code> in <code>make/local</code>.
</p></li>
<li>Support <code>RATE</code> as parameter in <code class="src src-stan">pmx_solve_rk45/bdf/adams</code>
functions.</li>
</ul>
</div>
</li>
<li><a id="0-85-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-85-changed">
<ul class="org-ul">
<li>Some fixes on steady-state solvers</li>
<li>Update to rstan version 2.19.2.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org26032a4" class="outline-4">
<h4 id="org26032a4"><span class="section-number-4">1.4.4</span> Version 0.86 <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-05-15 Wed&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-4">
</div>
<ul class="org-ul">
<li><a id="0-85-added"></a>Added<br />
<div class="outline-text-5" id="text-0-85-added">
<ul class="org-ul">
<li><p>
Torsten's ODE integrator functions
</p>
<ul class="org-ul">
<li><code class="src src-stan">pmx_integrate_ode_adams</code></li>
<li><code class="src src-stan">pmx_integrate_ode_bdf</code></li>
<li><code class="src src-stan">pmx_integrate_ode_rk45</code></li>
</ul>
<p>
and their counterparts to solve a population/group of
subjects governed by an ODE
</p>
<ul class="org-ul">
<li><code class="src src-stan">pmx_integrate_ode_group_adams</code></li>
<li><code class="src src-stan">pmx_integrate_ode_group_bdf</code></li>
<li><code class="src src-stan">pmx_integrate_ode_group_rk45</code></li>
</ul></li>
<li>Torsten's population PMX solver functions for general
ODE models
<ul class="org-ul">
<li><code class="src src-stan">pmx_solve_group_adams</code></li>
<li><code class="src src-stan">pmx_solve_group_bdf</code></li>
<li><code class="src src-stan">pmx_solve_group_rk45</code></li>
</ul></li>
<li>Support time step <code>ts</code> as parameter in <code class="src src-stan">pmx_integrate_ode_xxx</code>
solvers.</li>
</ul>
</div>
</li>
<li><a id="0-85-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-85-changed">
<ul class="org-ul">
<li><p>
Renaming Torsten functions in previous releases, the
old-new name mapping is
</p>
<ul class="org-ul">
<li><code class="src src-stan">PKModelOneCpt</code> &rarr; <code class="src src-stan">pmx_solve_onecpt</code></li>
<li><code class="src src-stan">PKModelTwoCpt</code> &rarr; <code class="src src-stan">pmx_solve_onecpt</code></li>
<li><code class="src src-stan">linOdeModel</code> &rarr; <code class="src src-stan">pmx_solve_linode</code></li>
<li><code class="src src-stan">generalOdeModel_adams</code> &rarr; <code class="src src-stan">pmx_solve_adams</code></li>
<li><code class="src src-stan">generalOdeModel_bdf</code> &rarr; <code class="src src-stan">pmx_solve_bdf</code></li>
<li><code class="src src-stan">generalOdeModel_rk45</code> &rarr; <code class="src src-stan">pmx_solve_rk45</code></li>
<li><code class="src src-stan">mixOde1CptModel_bdf</code> &rarr; <code class="src src-stan">pmx_solve_onecpt_bdf</code></li>
<li><code class="src src-stan">mixOde1CptModel_rk45</code> &rarr; <code class="src src-stan">pmx_solve_onecpt_rk45</code></li>
<li><code class="src src-stan">mixOde2CptModel_bdf</code> &rarr; <code class="src src-stan">pmx_solve_twocpt_bdf</code></li>
<li><code class="src src-stan">mixOde2CptModel_rk45</code> &rarr; <code class="src src-stan">pmx_solve_twocpt_rk45</code></li>
</ul>
<p>
Note that the new version of the above functions return
the <i>transpose</i> of the matrix returned by the old
versions, in order to improve memory efficiency. The old version are retained but will be
deprecated in the future. 
</p></li>
<li>Update to Stan version 2.19.1.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org71de615" class="outline-4">
<h4 id="org71de615"><span class="section-number-4">1.4.5</span> Version 0.85 <span class="timestamp-wrapper"><span class="timestamp">&lt;2018-12-04 Tue&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-5">
</div>
<ul class="org-ul">
<li><a id="0-85-added"></a>Added<br />
<div class="outline-text-5" id="text-0-85-added">
<ul class="org-ul">
<li>Dosing rate as parameter</li>
</ul>
</div>
</li>
<li><a id="0-85-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-85-changed">
<ul class="org-ul">
<li>Update to Stan version 2.18.0.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-orga50acf5" class="outline-4">
<h4 id="orga50acf5"><span class="section-number-4">1.4.6</span> Version 0.84 <span class="timestamp-wrapper"><span class="timestamp">&lt;2018-02-24 Sat&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-6">
</div>
<ul class="org-ul">
<li><a id="0-84-added"></a>Added<br />
<div class="outline-text-5" id="text-0-84-added">
<ul class="org-ul">
<li>Piecewise linear interpolation function.</li>
<li>Univariate integral functions.</li>
</ul>
</div>
</li>

<li><a id="0-84-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-84-changed">
<ul class="org-ul">
<li>Update to Stan version 2.17.1.</li>
<li>Minor revisions to User Manual.</li>
<li>Bugfixes.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org696e5e6" class="outline-4">
<h4 id="org696e5e6"><span class="section-number-4">1.4.7</span> Version 0.83 <span class="timestamp-wrapper"><span class="timestamp">&lt;2017-08-02 Wed&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-7">
</div>
<ul class="org-ul">
<li><a id="0-83-added"></a>Added<br />
<div class="outline-text-5" id="text-0-83-added">
<ul class="org-ul">
<li>Work with TorstenHeaders</li>
<li>Each chain has a different initial estimate</li>
</ul>
</div>
</li>

<li><a id="0-83-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-83-changed">
<ul class="org-ul">
<li>User manual</li>
<li>Fix misspecification in ODE system for TwoCpt example.</li>
<li>Other bugfixes</li>
</ul>
</div>
</li>
</ul>
</div>


<div id="outline-container-org637dc7b" class="outline-4">
<h4 id="0-82-added"><span class="section-number-4">1.4.8</span> Version 0.82 <span class="timestamp-wrapper"><span class="timestamp">&lt;2017-01-29 Sun&gt;</span></span></h4>
<div class="outline-text-4" id="text-0-82-added">
</div>
<ul class="org-ul">
<li><a id="org9f80285"></a>Added<br />
<div class="outline-text-5" id="text-org9f80285">
<ul class="org-ul">
<li>Allow parameter arguments to be passed as 1D or 2D arrays</li>
<li>More unit tests</li>
<li>Unit tests check automatic differentiation against finite differentiation.</li>
</ul>
</div>
</li>

<li><a id="0-82-changed"></a>Changed<br />
<div class="outline-text-5" id="text-0-82-changed">
<ul class="org-ul">
<li>Split the parameter argument into three arguments: pMatrix
(parameters for the ODEs &#x2013; note: for <code>linOdeModel</code>, pMatrix
is replaced by the constant rate matrix K), biovar
(parameters for the biovariability), and tlag (parameters
for the lag time).</li>
<li>bugfixes</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgdbc8ed2" class="outline-4">
<h4 id="orgdbc8ed2"><span class="section-number-4">1.4.9</span> Version 0.81 <span class="timestamp-wrapper"><span class="timestamp">&lt;2016-09-27 Tue&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-9">
</div>
<ul class="org-ul">
<li><a id="0-81-added"></a>Added<br />
<div class="outline-text-5" id="text-0-81-added">
<p>
linCptModel (linear compartmental model) function
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org99c4000" class="outline-4">
<h4 id="org99c4000"><span class="section-number-4">1.4.10</span> Version 0.80a <span class="timestamp-wrapper"><span class="timestamp">&lt;2016-09-21 Wed&gt;</span></span></h4>
<div class="outline-text-4" id="text-1-4-10">
</div>
<ul class="org-ul">
<li><a id="0-80a-added"></a>Added<br />
<div class="outline-text-5" id="text-0-80a-added">
<p>
check_finite statements in pred_1 and pred_2 to reject metropolis proposal if initial conditions are not finite
</p>
</div>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf18b586" class="outline-2">
<h2 id="orgf18b586"><span class="section-number-2">2</span> Installation</h2>
<div class="outline-text-2" id="text-2">
<p>
Currently Torsten is based on a forked version of Stan and hosted on GitHub
</p>
<ul class="org-ul">
<li><a href="https://github.com/metrumresearchgroup/Torsten">https://github.com/metrumresearchgroup/Torsten</a></li>
</ul>
<p>
The latest v0.89rc is
compatible with Stan v2.27.0. Torsten can be accessed from
command line for cmdstan interface and <code>cmdstanr</code>
(<a href="https://mc-stan.org/cmdstanr/">https://mc-stan.org/cmdstanr/</a>) for R interface. It requires
a modern C++11 compiler as well as a Make utility. See (<a href="#citeproc_bib_item_9">Team 2020</a>) for details of installation and
required toolchain. In particular, we recommend the folowing versions
of C++ compilers:
</p>
<ul class="org-ul">
<li>Linux: g++ &gt;=7.5 or clang &gt;=8.0,</li>
<li>macOS: the XCode version of clang,</li>
<li>Windows: g++ 8.1 (available with RTools 4.0).</li>
</ul>

<p>
On windows, the Make utility <code>mingw32-make</code> can be installed as part
of RTools.
</p>
</div>

<div id="outline-container-orgaae5862" class="outline-3">
<h3 id="orgaae5862"><span class="section-number-3">2.1</span> Command line interface</h3>
<div class="outline-text-3" id="text-2-1">
<p>
The command line interface <code>cmdstan</code> is available along with Torsten
and can be found at <code>Torsten/cmdstan</code>. 
</p>

<p>
After installation, one can use the following command to build a Torsten model <code>model_name</code> in <code>model_path</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #839496; font-weight: bold;">cd</span> Torsten/cmdstan
make model_path/model_name <span style="color: #586e75;"># </span><span style="color: #586e75;">replace "make" with "mingw32-make" on Windows platform</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org31b9e7a" class="outline-3">
<h3 id="org31b9e7a"><span class="section-number-3">2.2</span> R interface</h3>
<div class="outline-text-3" id="text-2-2">
<p>
After installing cmdstanr from <a href="https://mc-stan.org/cmdstanr/">https://mc-stan.org/cmdstanr/</a>, use the
following command to set path 
</p>
<div class="org-src-container">
<pre class="src src-r">cmdstanr::set_cmdstan_path(<span style="color: #2aa198;">"Torsten/cmdstan"</span>)
</pre>
</div>
<p>
Then one can follow <a href="https://mc-stan.org/cmdstanr/articles/cmdstanr.html">https://mc-stan.org/cmdstanr/articles/cmdstanr.html</a> to compile
and run Torsten models.
</p>
</div>
</div>

<div id="outline-container-orgd460284" class="outline-3">
<h3 id="orgd460284"><span class="section-number-3">2.3</span> MPI support</h3>
<div class="outline-text-3" id="text-2-3">
<p>
\label{sec:mpi_support}
Torsten's MPI support is of a different flavour than
<code>reduce_sum</code> found in Stan. To be able to utilize MPI
parallelisation, one first needs to ensure an MPI library
such as 
</p>
<ul class="org-ul">
<li><a href="https://www.mpich.org/downloads/">https://www.mpich.org/downloads/</a></li>
<li><a href="https://www.open-mpi.org/software/ompi/">https://www.open-mpi.org/software/ompi/</a></li>
</ul>
<p>
is available. Torsen's implementation is tested on
both <code>MPICH</code> and <code>OpenMPI</code>.
</p>

<p>
To use MPI-supported population/group solvers,
add/edit <code>make/local</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #268bd2;">TORSTEN_MPI</span>=1

<span style="color: #586e75;"># </span><span style="color: #586e75;">path to MPI headers</span>
CXXFLAGS += -isystem /usr/local/include
<span style="color: #586e75;"># </span><span style="color: #586e75;">if you are using Metrum's metworx platform, add MPICH3's</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">headers with</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">CXXFLAGS += -isystem /usr/local/mpich3/include</span>
</pre>
</div>
<p>
Note that currently <code>TORSTEN_MPI</code> and <code>STAN_MPI</code> flags
conflict on processes management and cannot be used in a
same Stan model, and MPI support is only available through <code>cmdstan</code>
interface.
</p>
</div>
</div>

<div id="outline-container-org6468ec1" class="outline-3">
<h3 id="org6468ec1"><span class="section-number-3">2.4</span> Testing</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Models in <code>example-models</code> directory are for tutorial and demonstration.
The following shows how to build and run the two-compartment model
using <code>cmdstanr</code>, and use <code>bayesplot</code> to examine posterior density of <code>CL</code>.
</p>
<div class="org-src-container">
<pre class="src src-r"><span style="color: #268bd2; font-weight: bold;">library</span>(<span style="color: #2aa198;">"cmdstanr"</span>)
set_cmdstan_path(<span style="color: #2aa198;">"Torsten/cmdstan"</span>)
file.dir <span style="color: #268bd2; font-weight: bold;">&lt;-</span> file.path(<span style="color: #2aa198;">"Torsten"</span>, <span style="color: #2aa198;">"example-models"</span>, <span style="color: #2aa198;">"pk2cpt"</span>)
file  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> file.path(file.dir, <span style="color: #2aa198;">"pk2cpt.stan"</span>)
model <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cmdstan_model(file)
fit <span style="color: #268bd2; font-weight: bold;">&lt;-</span> model$sample(data = file.path(file.dir, <span style="color: #2aa198;">"pk2cpt.data.R"</span>),
                    init = file.path(file.dir, <span style="color: #2aa198;">"pk2cpt.init.R"</span>),
                    seed = 123,
                    chains = 4,
                    parallel_chains = 2,
                    refresh = 500)
bayesplot::mcmc_dens_overlay(fit$draws(<span style="color: #2aa198;">"CL"</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc437d9b" class="outline-2">
<h2 id="orgc437d9b"><span class="section-number-2">3</span> Using Torsten</h2>
<div class="outline-text-2" id="text-3">
<p>
The reader should have a basic understanding of how Stan works before
reading this chapter. There are excellent resources online to get
started with Stan (<a href="http://mc-stan.org/documentation">http://mc-stan.org/documentation</a>).
In this section we go through the different functions Torsten adds to
Stan. The code for the examples can be found at the <code>example-models</code> folder. 
</p>

<p>
Torsten's functions are prefixed with <code>pmx_</code>. 
For some of their arguments we adopt NM-TRAN format for events
specification(Table <a href="#tab:event_args">tab:event_args</a>).
</p>
<table id="orgb67e0d5" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> NM-TRAN compatible event specification arguments. All arrays should have the same length corresponding to the number of events.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Argument Name</th>
<th scope="col" class="org-left">Definition</th>
<th scope="col" class="org-left">Stan data type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>time</code></td>
<td class="org-left">event time</td>
<td class="org-left"><code>real[]</code></td>
</tr>

<tr>
<td class="org-left"><code>amt</code></td>
<td class="org-left">dosing amount</td>
<td class="org-left"><code>real[]</code></td>
</tr>

<tr>
<td class="org-left"><code>rate</code></td>
<td class="org-left">infusion rate</td>
<td class="org-left"><code>real[]</code></td>
</tr>

<tr>
<td class="org-left"><code>ii</code></td>
<td class="org-left">interdose interval</td>
<td class="org-left"><code>real[]</code></td>
</tr>

<tr>
<td class="org-left"><code>evid</code></td>
<td class="org-left">event ID</td>
<td class="org-left"><code>int[]</code></td>
</tr>

<tr>
<td class="org-left"><code>cmt</code></td>
<td class="org-left">event compartment</td>
<td class="org-left"><code>int[]</code></td>
</tr>

<tr>
<td class="org-left"><code>addl</code></td>
<td class="org-left">additionial identical doses</td>
<td class="org-left"><code>int[]</code></td>
</tr>

<tr>
<td class="org-left"><code>ss</code></td>
<td class="org-left">steady-state dosing flag</td>
<td class="org-left"><code>int[]</code></td>
</tr>
</tbody>
</table>
<p>
All the <code class="src src-stan"><span style="color: #b58900;">real</span>[]</code> arguments above are allowed to
be <code class="src src-stan">parameters</code> in a Stan model.
In addtion, Torsten functions
support optional arguments and overloaded signatures.
Optional arguments are indicated by surrounding square bracket <code>[]</code>.
Table below shows three commonly used PMX model arguments that support
overloading. In the rest of this document we assume this convention unless indicated otherwise.
</p>
<table id="orgbb12ddf" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> PMX model parameter overloadings. One can use 1d array <code class="src src-stan"><span style="color: #b58900;">real</span>[]</code> to indicate constants of all events, or 2d array <code class="src src-stan"><span style="color: #b58900;">real</span>[ , ]</code> so that the \(i\)th row of the array describes the model arguments for time interval \((t_{i-1}, t_i)\), and the number of the rows equals to the size of <code>time</code>.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Argument Name</th>
<th scope="col" class="org-left">Definition</th>
<th scope="col" class="org-left">Stan data type</th>
<th scope="col" class="org-left">Optional</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>theta</code></td>
<td class="org-left">model parameters</td>
<td class="org-left"><code>real[]</code> or <code>real[ , ]</code></td>
<td class="org-left">N</td>
</tr>

<tr>
<td class="org-left"><code>biovar</code></td>
<td class="org-left">bioavailability fraction</td>
<td class="org-left"><code>real[]</code> or <code>real[ , ]</code></td>
<td class="org-left">Y (default to 1.0)</td>
</tr>

<tr>
<td class="org-left"><code>tlag</code></td>
<td class="org-left">lag time</td>
<td class="org-left"><code>real[]</code> or <code>real[ , ]</code></td>
<td class="org-left">Y (default to 0.0)</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org218a6ac" class="outline-3">
<h3 id="org218a6ac"><span class="section-number-3">3.1</span> One Compartment Model</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org82ef22e" class="outline-4">
<h4 id="org82ef22e"><span class="section-number-4">3.1.1</span> Description</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Function <code>pmx_solve_onecpt</code> solves a one-compartment PK
model (Figure <a href="#org5f13838">1</a>). The model obtains plasma concentrations of parent drug \(c=y_2/V_2\)
by solving for the mass of drug in the central compartment
\(y_2\) from ordinary differential equations(ODEs)
</p>
\begin{align}\label{eq:onecpt}
  y_1' &= -k_a y_1, \\
  y_2' &= k_a y_1 - \left(\frac{CL}{V_2} + \frac{Q}{V_2}\right) y_2.
\end{align}

<div id="org5f13838" class="figure">
<p><img src="./graphics/cptModels.png" alt="cptModels.png" />
</p>
<p><span class="figure-number">Figure 1: </span>One and two compartment models with first order absorption implemented in Torsten.</p>
</div>
</div>
</div>

<div id="outline-container-org8daa289" class="outline-4">
<h4 id="org8daa289"><span class="section-number-4">3.1.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-1-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_onecpt(time, amt, rate, ii, evid, cmt, addl, ss, theta [, biovar, tlag ] )
</pre>
</div>
</div>
</div>

<div id="outline-container-org5a0a754" class="outline-4">
<h4 id="org5a0a754"><span class="section-number-4">3.1.3</span> Arguments</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
See Table <a href="#tab:event_args">tab:event_args</a> and Table <a href="#tab:event_params">tab:event_params</a>.
</p>
</div>
</div>
<div id="outline-container-org6db00b7" class="outline-4">
<h4 id="org6db00b7"><span class="section-number-4">3.1.4</span> Return value</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
An <code>ncmt</code>-by-<code>nt</code> matrix, where <code>nt</code> is the number of time steps and <code>ncmt=2</code> is the number of compartments.    
</p>
</div>
</div>
<div id="outline-container-org2fe3795" class="outline-4">
<h4 id="org2fe3795"><span class="section-number-4">3.1.5</span> Note</h4>
<div class="outline-text-4" id="text-3-1-5">
<ul class="org-ul">
<li>ODE Parameters <code>theta</code> should consist of \(CL\), \(V_2\), \(k_a\), in that order.</li>
<li><code>biovar</code> and <code>tlag</code> are optional, so that the following are allowed:</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan">pmx_solve_onecpt(..., theta);
pmx_solve_onecpt(..., theta, biovar);
pmx_solve_onecpt(..., theta, biovar, tlag);
</pre>
</div>
<ul class="org-ul">
<li>Setting \(k_a = 0\) eliminates the first-order absorption.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org61ca17d" class="outline-3">
<h3 id="org61ca17d"><span class="section-number-3">3.2</span> Two Compartment Model</h3>
<div class="outline-text-3" id="text-3-2">
<p>
<a id="org2582672"></a>
</p>
</div>
<div id="outline-container-org073fcdc" class="outline-4">
<h4 id="org073fcdc"><span class="section-number-4">3.2.1</span> Description</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Function <code>pmx_solve_twocpt</code> solves a two-compartment PK
model (Figure <a href="#org5f13838">1</a>). The model obtains plasma concentrations of parent drug \(c=y_2/V_2\)
by solving for the mass of drug in the central compartment
\(y_2\) from ordinary differential equations(ODEs)
</p>
\begin{align} \label{eq:twocpt}
  y_1' &= -k_a y_1 \\
  y_2' &= k_a y_1 - \left(\frac{CL}{V_2} + \frac{Q}{V_2}\right) y_2 +  \frac{Q}{V_3}  y_3  \\ 
  y_3' &= \frac{Q}{V_2} y_2 - \frac{Q}{V_3} y_3
\end{align}
</div>
</div>

<div id="outline-container-org188a088" class="outline-4">
<h4 id="org188a088"><span class="section-number-4">3.2.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-2-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_twocpt(time, amt, rate, ii, evid, cmt, addl, ss, theta [, biovar, tlag ] )
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd64ca22" class="outline-4">
<h4 id="orgd64ca22"><span class="section-number-4">3.2.3</span> Arguments</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
See Table <a href="#tab:event_args">tab:event_args</a> and Table <a href="#tab:event_params">tab:event_params</a>.
</p>
</div>
</div>

<div id="outline-container-org8447a4f" class="outline-4">
<h4 id="org8447a4f"><span class="section-number-4">3.2.4</span> Return value</h4>
<div class="outline-text-4" id="text-3-2-4">
<p>
An <code>ncmt</code>-by-<code>nt</code> matrix, where <code>nt</code> is the number of time steps and <code>ncmt=3</code> is the number of compartments.
</p>
</div>
</div>

<div id="outline-container-org38fd650" class="outline-4">
<h4 id="org38fd650"><span class="section-number-4">3.2.5</span> Note</h4>
<div class="outline-text-4" id="text-3-2-5">
<ul class="org-ul">
<li>ODE Parameters <code>theta</code> consists of \(CL\), \(Q\), \(V_2\), \(V_3\), \(k_a\).</li>
<li><code>biovar</code> and <code>tlag</code> are optional, so that the following are allowed:</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan">pmx_solve_twocpt(..., theta);
pmx_solve_twocpt(..., theta, biovar);
pmx_solve_twocpt(..., theta, biovar, tlag);
</pre>
</div>
<ul class="org-ul">
<li>Setting \(k_a = 0\) eliminates the first-order absorption.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org9769dac" class="outline-3">
<h3 id="org9769dac"><span class="section-number-3">3.3</span> General Linear ODE Model Function</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-orgbe184c2" class="outline-4">
<h4 id="orgbe184c2"><span class="section-number-4">3.3.1</span> Description</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Function <code>pmx_solve_linode</code> solves a (piecewise) linear ODEs model with coefficients
in form of matrix \(K\)
</p>
\begin{equation}
y^\prime\left(t\right) = Ky\left(t\right)
\end{equation}
<p>
For example, in a two-compartment model with first order absorption, \(K\) is
</p>
\begin{equation}
  K = \left[\begin{array}{ccc}
              -k_a & 0 & 0 \\
              k_a & -\left(k_{10} + k_{12}\right) & k_{21} \\
              0 & k_{12} & -k_{21}
            \end{array}\right]
\end{equation}
<p>
where \(k_{10}=CL/V_2\), \(k_{12}=Q/V_2\), and \(k_{21}=Q/V_3\).
</p>
</div>
</div>

<div id="outline-container-org21770f9" class="outline-4">
<h4 id="org21770f9"><span class="section-number-4">3.3.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-3-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_linode(time, amt, rate, ii, evid, cmt, addl, ss, K, biovar, tlag )
</pre>
</div>
</div>
</div>

<div id="outline-container-org170ac34" class="outline-4">
<h4 id="org170ac34"><span class="section-number-4">3.3.3</span> Arguments</h4>
<div class="outline-text-4" id="text-3-3-3">
<ul class="org-ul">
<li><code>K</code>
System parameters. <code>K</code> can be either
<ul class="org-ul">
<li>a <code class="src src-stan"><span style="color: #b58900;">matrix</span></code> for constant parameters in all events, or</li>
<li>an array of matrices <code class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2;">K</span>[nt]</code> so that the \(i\)th entry of the array describes
the model parameters for time interval \((t_{i-1}, t_i)\),
and the number of the rows equals to the number of event time <code>nt</code>.</li>
</ul></li>
<li>See Table <a href="#tab:event_args">tab:event_args</a> and Table <a href="#tab:event_params">tab:event_params</a> for the rest of arguments.</li>
</ul>
</div>
</div>

<div id="outline-container-org994e5ca" class="outline-4">
<h4 id="org994e5ca"><span class="section-number-4">3.3.4</span> Return value</h4>
<div class="outline-text-4" id="text-3-3-4">
<p>
An <code>n</code>-by-<code>nt</code> matrix, where <code>nt</code> is the number of time steps and <code>n</code> is the number of rows(columns) of square matrix <code>K</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-org1d7de98" class="outline-3">
<h3 id="org1d7de98"><span class="section-number-3">3.4</span> General ODE Model Function</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-org1a2012a" class="outline-4">
<h4 id="org1a2012a"><span class="section-number-4">3.4.1</span> Description</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Function <code>pmx_solve_adams</code>, <code>pmx_solve_bdf</code>, and <code>pmx_solve_rk45</code> solve a first-order ODE system
specified by user-specified right-hand-side function <code>ODE_rhs</code> \(f\)
</p>
\begin{equation*}
y'(t) = f(t, y(t))
\end{equation*}
<p>
In the case where the <code>rate</code> vector \(r\) is non-zero, this equation becomes:
</p>
\begin{equation*}
y'(t) = f(t, y(t)) + r
\end{equation*}
</div>
</div>
<div id="outline-container-orgcdede8e" class="outline-4">
<h4 id="orgcdede8e"><span class="section-number-4">3.4.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-4-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2;">pmx_solve_</span>[adams || rk45 || bdf](ODE_rhs, <span style="color: #b58900;">int</span> nCmt, time, amt, rate, ii, evid, cmt, addl, ss, theta, [ biovar, tlag, <span style="color: #b58900;">real</span>[,] x_r, <span style="color: #b58900;">int</span> [,] x_i, <span style="color: #b58900;">real</span> rel_tol, <span style="color: #b58900;">real</span> abs_tol, <span style="color: #b58900;">int</span> max_step, <span style="color: #b58900;">real</span> as_rel_tol, <span style="color: #b58900;">real</span> as_abs_tol, <span style="color: #b58900;">int</span> as_max_step ] );
</pre>
</div>
<p>
Here <code class="src src-stan">[adams || rk45 || bdf]</code> indicates the
function name can use any of the three suffixes. See below.
</p>
</div>
</div>

<div id="outline-container-org5759fca" class="outline-4">
<h4 id="org5759fca"><span class="section-number-4">3.4.3</span> Arguments</h4>
<div class="outline-text-4" id="text-3-4-3">
<ul class="org-ul">
<li><code>ODE_rhs</code>
ODE right-hand-side \(f\). It should be defined in
<code class="src src-stan">functions</code> block and has the following format</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">vector</span> <span style="color: #268bd2; font-weight: bold;">=</span> f(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">vector</span> y, <span style="color: #b58900;">real</span>[] param, <span style="color: #b58900;">real</span>[] dat_r, <span style="color: #b58900;">int</span>[] dat_i) {...}
</pre>
</div>
<p>
Here <code>t</code> is time, <code>y</code> the unknowns of ODE, <code>param</code> the parameters, <code>dat\_r</code> the real data, <code>dat\_i</code>
the integer data. <code>param</code>,
<code>dat\_r</code>, and <code>dat\_i</code> are from
the entry of <code>theta</code>, <code>x_r</code>,
and <code>x_i</code> corresponding to
<code>t</code>, respectively.
\(f\) should not include dosing rates in its
definition, as Torsten automatically update \(f\)
when the corresponding event indicates infusion dosage.
</p>
<ul class="org-ul">
<li><code>nCmt</code> 
The number of compartments, equivalently, the dimension of the ODE system.</li>
<li><code>x_r</code>
2d arary real data to be passed to ODE RHS. If specified, its 1st
dimension should have the same size as <code>time</code>.</li>
<li><code>x_i</code>
2d arary integer data to be passed to ODE RHS. If specified, its 1st
dimension should have the same size as <code>time</code>.</li>
<li><code>rel_tol</code> 
The relative tolerance for numerical integration, default to 1.0E-6.</li>
<li><code>abs_tol</code>
The absolute tolerance for numerical integration, default to 1.0E-6.</li>
<li><code>max_step</code>
The maximum number of steps in numerical integration, default to \(10^6\).</li>
<li><code>as_rel_tol</code>
The relative tolerance for algebra solver for steady state solution, default to 1.0E-6.</li>
<li><code>as_abs_tol</code>
The absolute tolerance for algebra solver for steady state solution, default to 1.0E-6.</li>
<li><code>as_max_step</code>
The maximum number of interations in algebra solver for steady state solution, default to \(10^2\).</li>
<li>See Table <a href="#tab:event_args">tab:event_args</a> and Table <a href="#tab:event_params">tab:event_params</a> for the rest of arguments.</li>
</ul>
</div>
</div>

<div id="outline-container-org2e4b2de" class="outline-4">
<h4 id="org2e4b2de"><span class="section-number-4">3.4.4</span> Return value</h4>
<div class="outline-text-4" id="text-3-4-4">
<p>
An <code>nCmt</code>-by-<code>nt</code> matrix, where <code>nt</code> is the size of <code>time</code>.
</p>
</div>
</div>
<div id="outline-container-orged5aee8" class="outline-4">
<h4 id="orged5aee8"><span class="section-number-4">3.4.5</span> Note</h4>
<div class="outline-text-4" id="text-3-4-5">
<ul class="org-ul">
<li>See section <a href="#sec:ode_func_note">sec:ode_func_note</a> for different types of integrator and general guidance.</li>
<li>See section <a href="#sec:ode_func_note">sec:ode_func_note</a> for comments on accuracy and tolerance.</li>
<li>The default values of <code>atol</code>,
<code>rtol</code>, and <code>max_step</code> are
based on a limited amount of PKPD test problems and should not be considered as
universally applicable. We strongly recommend user to set these values
according to physical intuition and numerical tests. See also Secion
<a href="#sec:ode_func_note">sec:ode_func_note</a>.</li>
<li>With optional arguments indicated by square bracket, the following calls are allowed:</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan">pmx_solve_[adams || rk45 || bdf](..., theta);
pmx_solve_[adams || rk45 || bdf](..., theta, rel_tol, abs_tol, max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, rel_tol, abs_tol, max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, rel_tol, abs_tol, max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, rel_tol, abs_tol, max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, x_i);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, x_i, rel_tol, abs_tol, max_step);
pmx_solve_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, x_i, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orged731ab" class="outline-3">
<h3 id="orged731ab"><span class="section-number-3">3.5</span> Coupled ODE Model Function</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-org784f68d" class="outline-4">
<h4 id="org784f68d"><span class="section-number-4">3.5.1</span> Description</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
When the ODE system consists of two subsystems in form of
</p>
\begin{align*}
  y_1^\prime &= f_1(t, y_1), \\
  y_2^\prime &= f_2(t, y_1, y_2),
\end{align*}
<p>
with \(y_1\), \(y_2\), \(f_1\), and \(f_2\) being vector-valued functions, and
\(y_1^\prime\) independent of \(y_2\), the solution can be
accelerated if \(y_1\) admits an analytical solution which can
be introduced into the ODE for \(y_2\) for numerical
integration. This structure arises in PK/PD
models, where \(y_1\) describes a forcing PK function and \(y_2\) the PD
effects. In the example of a Friberg-Karlsson
semi-mechanistic model(see below), we observe an average speedup of
\(\sim 47 \pm 18 \%\) when using the mix solver in lieu of the numerical
integrator. In the context, currently the couple solver supports one-
&amp; two-compartment for PK model, and <code>rk45</code> &amp;
<code>bdf</code> integrator for nonlinear PD model.
</p>
</div>
</div>
<div id="outline-container-orgfea8cee" class="outline-4">
<h4 id="orgfea8cee"><span class="section-number-4">3.5.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-5-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2;">pmx_solve_onecpt_</span>[ rk45 || bdf ](reduced_ODE_system, <span style="color: #b58900;">int</span> nOde, time, amt, rate, ii, evid, cmt, addl, ss, theta, biovar, tlag [, <span style="color: #b58900;">real</span> rel_tol, <span style="color: #b58900;">real</span> abs_tol, <span style="color: #b58900;">int</span> max_step, <span style="color: #b58900;">real</span> as_rel_tol, <span style="color: #b58900;">real</span> as_abs_tol, <span style="color: #b58900;">int</span> as_max_step ] );
<span style="color: #b58900;">matrix</span> <span style="color: #268bd2;">pmx_solve_twocpt_</span>[ rk45 || bdf ](reduced_ODE_system, <span style="color: #b58900;">int</span> nOde, time, amt, rate, ii, evid, cmt, addl, ss, theta, biovar, tlag [, <span style="color: #b58900;">real</span> rel_tol, <span style="color: #b58900;">real</span> abs_tol, <span style="color: #b58900;">int</span> max_step, <span style="color: #b58900;">real</span> as_rel_tol, <span style="color: #b58900;">real</span> as_abs_tol, <span style="color: #b58900;">int</span> as_max_step ] );
</pre>
</div>
</div>
</div>
<div id="outline-container-org808a5e6" class="outline-4">
<h4 id="org808a5e6"><span class="section-number-4">3.5.3</span> Arguments</h4>
<div class="outline-text-4" id="text-3-5-3">
</div>
<ul class="org-ul">
<li><a id="orgf6d501a"></a><code>reduced\_ODE\_rhs</code><br />
<div class="outline-text-5" id="text-orgf6d501a">
<p>
The system  numerically solve (\(y_2\) in the above discussion, also called the
<i>reduced system</i> and <code>nOde</code> the number of equations in
the \underline{reduced} system. The function that defines a reduced
system has an almost identical signature to that used for a full
system, but takes one additional argument: \(y_1\), the PK states,
i.e. solution to the PK ODEs.
</p>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">vector</span> <span style="color: #268bd2;">reduced_ODE_rhs</span>(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">vector</span> y2, <span style="color: #b58900;">vector</span> y1, <span style="color: #b58900;">real</span>[] theta, <span style="color: #b58900;">real</span>[] x_r, <span style="color: #b58900;">int</span>[] x_i) 
</pre>
</div>
</div>
</li>
<li><a id="orge81cd77"></a><code>nCmt</code><br />
<div class="outline-text-5" id="text-orge81cd77">
<p>
The number of compartments. Equivalently, the dimension of the ODE system.
</p>
</div>
</li>
<li><a id="org3b08184"></a><code>rel_tol</code><br />
<div class="outline-text-5" id="text-org3b08184">
<p>
The relative tolerance for numerical integration, default to 1.0E-6.
</p>
</div>
</li>
<li><a id="org35fcab7"></a><code>abs_tol</code><br />
<div class="outline-text-5" id="text-org35fcab7">
<p>
The absolute tolerance for numerical integration, default to 1.0E-6.
</p>
</div>
</li>
<li><a id="org2b5b4bf"></a><code>max_step</code><br />
<div class="outline-text-5" id="text-org2b5b4bf">
<p>
The maximum number of steps in numerical integration, default to \(10^6\).
</p>
</div>
</li>
<li><a id="org1b51330"></a>See Table <a href="#tab:event_args">tab:event_args</a> and Table <a href="#tab:event_params">tab:event_params</a> for the rest of arguments.<br /></li>
</ul>
</div>
<div id="outline-container-org2b99bf0" class="outline-4">
<h4 id="org2b99bf0"><span class="section-number-4">3.5.4</span> Return value</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
    An <code>nPk + nOde</code>-by-<code>nt</code> matrix, where <code>nt</code> is the size of
    <code>time</code>, and <code>nPk</code> equals to 2 in
q    <code>pmx_solve_onecpt_</code> functions
    and 3 in <code>pmx_solve_twocpt_</code> functions.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf1b3b9a" class="outline-3">
<h3 id="orgf1b3b9a"><span class="section-number-3">3.6</span> General ODE-based Population Model Function</h3>
<div class="outline-text-3" id="text-3-6">
</div>
<div id="outline-container-org5dfabc2" class="outline-4">
<h4 id="org5dfabc2"><span class="section-number-4">3.6.1</span> Description</h4>
<div class="outline-text-4" id="text-3-6-1">
<p>
All the preivous functions solves for a single sunject. Torsten also
provides population modeling counterparts for ODE solutions. The
functions solve for a population that share an ODE model but with
subject-level parameters and event specifications and have similar
signatures to single-subject functions, except that now events
arguments <code>time</code>, <code>amt</code>, <code>rate</code>, <code>ii</code>,
<code>evid</code>, <code>cmt</code>,
<code>addl</code>, <code>ss</code> specifies the entire
population, one subject after another.
</p>
</div>
</div>
<div id="outline-container-org267c0cd" class="outline-4">
<h4 id="org267c0cd"><span class="section-number-4">3.6.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-6-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2;">pmx_solve_group_</span>[adams || rk45 || bdf](ODE_rhs, <span style="color: #b58900;">int</span> nCmt, <span style="color: #b58900;">int</span>[] len, time, amt, rate, ii, evid, cmt, addl, ss, theta, [ biovar, tlag, <span style="color: #b58900;">real</span>[,] x_r, <span style="color: #b58900;">int</span> [,] x_i, <span style="color: #b58900;">real</span> rel_tol, <span style="color: #b58900;">real</span> abs_tol, <span style="color: #b58900;">int</span> max_step, <span style="color: #b58900;">real</span> as_rel_tol, <span style="color: #b58900;">real</span> as_abs_tol, <span style="color: #b58900;">int</span> as_max_step ] );
</pre>
</div>
<p>
Here <code class="src src-stan">[adams || rk45 || bdf]</code> indicates the
function name can be of any of the three suffixes. See section <a href="#sec:ode_func_note">sec:ode_func_note</a>.
</p>
</div>
</div>
<div id="outline-container-org2715b0a" class="outline-4">
<h4 id="org2715b0a"><span class="section-number-4">3.6.3</span> Arguments</h4>
<div class="outline-text-4" id="text-3-6-3">
<ul class="org-ul">
<li><code>ODE_rhs</code>
Same as in Section <a href="#sec:general_ode">sec:general_ode</a>.</li>
<li><code>time</code>, <code>amt</code>, <code>rate</code>, <code>ii</code>, <code>evid</code>, <code>cmt</code>, <code>addl</code>, <code>ss</code>
2d-array arguments that describe data record for the
entire population (see also Table <a href="#tab:event_args">tab:event_args</a> and Table <a href="#tab:event_params">tab:event_params</a>). They must have same size in the first
dimension. Take <code>evid</code> for example. Let \(N\) be the
population size, then <code>evid[1,]</code> to
<code>evid[n1,]</code> specifies events ID for subject 1,
<code>evid[n1 + 1,]</code> to
<code>evid[n1 + n2,]</code> for subject 2, etc. With \(n_i\)
being the number of events for subject \(i\), \(i=1, 2, \dots, N\), the
size of <code>evid</code>'s first dimension is \(\sum_{i}n_i\).</li>
<li><code>len</code> 
The length of data for each subject within
the above events arrays. The size of <code>len</code> equals
to population size \(N\).</li>
<li><code>nCmt</code> 
The number of compartments. Equivalently, the dimension of the ODE system.</li>
<li><code>x_r</code>
2d arary real data to be passed to ODE RHS. If specified, its 1st
dimension should have the same size as <code>time</code>.</li>
<li><code>x_i</code>
2d arary integer data to be passed to ODE RHS. If specified, its 1st
dimension should have the same size as <code>time</code>.</li>
<li><code>rel_tol</code> 
The relative tolerance for numerical integration, default to 1.0E-6.</li>
<li><code>abs_tol</code>
The absolute tolerance for numerical integration, default to 1.0E-6.</li>
<li><code>max_step</code>
The maximum number of steps in numerical integration, default to \(10^6\).</li>
<li><code>as_rel_tol</code>
The relative tolerance for algebra solver for steady state solution, default to 1.0E-6.</li>
<li><code>as_abs_tol</code>
The absolute tolerance for algebra solver for steady state solution, default to 1.0E-6.</li>
<li><code>as_max_step</code>
The maximum number of interations in algebra solver for steady state solution, default to \(10^2\).</li>
</ul>
</div>
</div>
<div id="outline-container-org1895b10" class="outline-4">
<h4 id="org1895b10"><span class="section-number-4">3.6.4</span> Return value</h4>
<div class="outline-text-4" id="text-3-6-4">
<p>
An <code>nCmt</code>-by-<code>nt</code> matrix, where <code>nt</code> is the total size of
events \(\sum_{i}n_i\).
</p>
</div>
</div>
<div id="outline-container-org26403a1" class="outline-4">
<h4 id="org26403a1"><span class="section-number-4">3.6.5</span> Note</h4>
<div class="outline-text-4" id="text-3-6-5">
<p>
\label{sec:ode_group_note}
</p>
<ul class="org-ul">
<li>Similar to single-subject solvers, three numerical integrator are provided:
<ul class="org-ul">
<li><code>pmx_solve_group_adams</code>: Adams-Moulton method,</li>
<li><code>pmx_solve_group_bdf</code>: Backward-differentiation formular,</li>
<li><code>pmx_solve_group_rk45</code>: Runge-Kutta 4/5 method.</li>
</ul></li>
<li>With optional arguments indicated by square bracket, the following calls are allowed:</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan">pmx_solve_group_[adams || rk45 || bdf](..., theta);
pmx_solve_group_[adams || rk45 || bdf](..., theta, rel_tol, abs_tol, max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, rel_tol, abs_tol, max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, rel_tol, abs_tol, max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, rel_tol, abs_tol, max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, x_i);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, x_i, rel_tol, abs_tol, max_step);
pmx_solve_group_[adams || rk45 || bdf](..., theta, biovar, tlag, x_r, x_i, rel_tol, abs_tol, max_step, as_rel_tol, as_abs_tol, as_max_step);
</pre>
</div>
<ul class="org-ul">
<li>The group solvers support paralleisation through Message Passing
Interface(MPI). One can access this feature through <code>cmdstan</code> or
<code>cmdstanr</code> interface.</li>
</ul>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #586e75;"># </span><span style="color: #586e75;">cmdstan interface user need to add "TORSTEN_MPI=1" and</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">"TBB_CXX_TYPE=gcc" in "cmdstan/make/local" file. In linux &amp; macos</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">this can be done as</span>
<span style="color: #839496; font-weight: bold;">echo</span> <span style="color: #2aa198;">"TORSTEN_MPI=1"</span> &gt; cmdstan/make/local
<span style="color: #839496; font-weight: bold;">echo</span> <span style="color: #2aa198;">"TBB_CXX_TYPE=gcc"</span> &gt; cmdstan/make/local <span style="color: #586e75;"># </span><span style="color: #586e75;">"gcc" should be replaced by user's C compiler</span>
make path-to-model/model_name
mpiexec -n number_of_processes model_name sample... <span style="color: #586e75;"># </span><span style="color: #586e75;">additional cmdstan options</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-r"><span style="color: #268bd2; font-weight: bold;">library</span>(<span style="color: #2aa198;">"cmdstanr"</span>)
cmdstan_make_local(cpp_options = list(<span style="color: #2aa198;">"TORSTEN_MPI"</span> = <span style="color: #2aa198;">"1"</span>, <span style="color: #2aa198;">"TBB_CXX_TYPE"</span>=<span style="color: #2aa198;">"gcc"</span>))  <span style="color: #586e75;"># </span><span style="color: #586e75;">"gcc" should be replaced by user's C compiler</span>
rebuild_cmdstan()
mod <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cmdstan_model(path-to-model-file, quiet=<span style="color: #b58900;">FALSE</span>, force_recompile=<span style="color: #b58900;">TRUE</span>)
f <span style="color: #268bd2; font-weight: bold;">&lt;-</span> mod$sample_mpi(data = ..., chains = 1, mpi_args = list(<span style="color: #2aa198;">"n"</span> = number_of_processes), refresh = 200)
</pre>
</div>
<p>
Here \(n\) denotes number of MPI processes, so that \(N\)
ODE systems (each specified by a same RHS function and
subject-dependent events) are distributed to and solved by \(n\)
processes evenly. Note that to access this feature user must have
MPI installed, and some MPI installation may require set additional
compiler arguments, such as <code>CXXLFAGS</code> and <code>LDFLAGS</code>.
</p>
</div>
</div>
</div>
<div id="outline-container-org009a587" class="outline-3">
<h3 id="org009a587"><span class="section-number-3">3.7</span> ODE  integrator Function</h3>
<div class="outline-text-3" id="text-3-7">
</div>
<div id="outline-container-org2517b1a" class="outline-4">
<h4 id="org2517b1a"><span class="section-number-4">3.7.1</span> Description</h4>
<div class="outline-text-4" id="text-3-7-1">
<p>
Torsten provides its own implementation of ODE solvers that solves
</p>
\begin{equation*}
  y'(t) = f(t, y(t)), \quad y(t_0) = y_0
\end{equation*}
<p>
for \(y\). These solvers
are customized for Torsten applications and different from those found
in Stan. The general ODE PMX solvers in previous sections are internally powered
by these functions.
</p>
</div>
</div>
<div id="outline-container-org254de19" class="outline-4">
<h4 id="org254de19"><span class="section-number-4">3.7.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-7-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[ , ] <span style="color: #268bd2;">pmx_integrate_ode_</span>[ adams || bdf || rk45 ](ODE_rhs, <span style="color: #b58900;">real</span>[] y0, <span style="color: #b58900;">real</span> t0, <span style="color: #b58900;">real</span>[] ts, <span style="color: #b58900;">real</span>[] theta, <span style="color: #b58900;">real</span>[] x_r, <span style="color: #b58900;">int</span>[] <span style="color: #268bd2;">x_i</span> [ , <span style="color: #b58900;">real</span> rtol, <span style="color: #b58900;">real</span> atol, <span style="color: #b58900;">int</span> max_step ]);
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb0cfa71" class="outline-4">
<h4 id="orgb0cfa71"><span class="section-number-4">3.7.3</span> Arguments</h4>
<div class="outline-text-4" id="text-3-7-3">
<p>
\label{sec:ode_func_args}
</p>
<ul class="org-ul">
<li><code>ODE_rhs</code>
Function that specifies the right-hand-side \(f\).
It should be defined in
<code class="src src-stan">functions</code> block and has the following format</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">vector</span> <span style="color: #268bd2; font-weight: bold;">=</span> f(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">vector</span> y, <span style="color: #b58900;">real</span>[] param, <span style="color: #b58900;">real</span>[] dat_r, <span style="color: #b58900;">int</span>[] dat_i) {...}
</pre>
</div>
<p>
Here <code>t</code> is time, <code>y</code> the unknowns of ODE, <code>param</code> the parameters, <code>dat\_r</code> the real data, <code>dat\_i</code>
the integer data.
</p>
<ul class="org-ul">
<li><code>y0</code>
Initial condition \(y_0\).</li>
<li><code>t0</code>
Initial time \(t_0\).</li>
<li><code>ts</code>
Output time when solution is seeked.</li>
<li><code>theta</code>
Parameters to be passed to <code>ODE_rhs</code> function.</li>
<li><code>x_r</code>
Real data to be passed to <code>ODE_rhs</code> function.</li>
<li><code>x_i</code>
Integer data to be passed to <code>ODE_rhs</code> function.</li>
<li><code>rtol</code>
Relative tolerance, default to 1.e-6(<code>rk45</code>) and 1.e-8(<code>adams</code> and <code>bdf</code>).</li>
<li><code>atol</code>
Absolute tolerance, default to 1.e-6(<code>rk45</code>) and 1.e-8(<code>adams</code> and <code>bdf</code>).</li>
<li><code>max_step</code>
Maximum number of steps allowed between neighboring time in <code>ts</code>,
default to 100000.</li>
</ul>
</div>
</div>
<div id="outline-container-org098adf3" class="outline-4">
<h4 id="org098adf3"><span class="section-number-4">3.7.4</span> Return value</h4>
<div class="outline-text-4" id="text-3-7-4">
<p>
An <code>n</code>-by-<code>nd</code> 2d-array, where <code>n</code> is the size of <code>ts</code>
and <code>nd</code> the dimension of the system.
</p>
</div>
</div>
<div id="outline-container-org83c6b22" class="outline-4">
<h4 id="org83c6b22"><span class="section-number-4">3.7.5</span> Note</h4>
<div class="outline-text-4" id="text-3-7-5">
<p>
\label{sec:ode_func_note}
</p>
<ul class="org-ul">
<li><p>
Three numerical integrator are provided:
</p>
<ul class="org-ul">
<li><code>pmx_integrate_ode_adams</code>: Adams-Moulton method,</li>
<li><code>pmx_integrate_ode_bdf</code>: Backward-differentiation formular,</li>
<li><code>pmx_integrate_ode_rk45</code>: Runge-Kutta 4/5 method.</li>
</ul>
<p>
When not equipped with further understanding of the ODE system, as a
rule of thumb we suggest user try
<code>rk45</code> integrator first, <code>bdf</code>
integrator when the system is suspected to be stiff, and
<code>adams</code> when a non-stiff system needs to be solved
with higher accuracy/smaller tolerance.
</p></li>

<li><p>
All three integrators support adaptive stepping. To achieve
that, at step \(i\) estimated error \(e_i\) is calculated and
compared with given tolerance so that
</p>
\begin{equation}
  e_i < \Vert\text{rtol} \times \tilde{y} + \text{atol}\Vert
\end{equation}
<p>
Here \(\tilde{y}\) is the numerical solution of \(y\) at current
step and \(\Vert \cdot \Vert\) indicates certain norm. When the above check fails, the solver attempts
to reduce step size and retry. The default values of <code>atol</code>,
<code>rtol</code>, and <code>max_step</code> are
based on Stan's ODE functions and should not be considered as
optimal. User should make problem-dependent
decision on <code>rtol</code> and <code>atol</code>,
according to estimated scale of the unknowns, so that the error
would not affect inference on statistical variance of quantities
that enter the Stan model. In particular, when an unknown can be neglected
below certain threshold without affecting the rest of
the dynamic system, setting
<code>atol</code> greater than that threshold will avoid
spurious and error-prone computation. See
(<a href="#citeproc_bib_item_6">Hindmarsh et al. 2020</a>) and
1.4 of (<a href="#citeproc_bib_item_8">Shampine et al. 2003</a>) for details.
</p></li>

<li>With optional arguments indicated by square bracket, the following calls are allowed:</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan">pmx_integrate_ode_[adams || rk45 || bdf](..., x_i);
pmx_integrate_ode_[adams || rk45 || bdf](..., x_i, rel_tol, abs_tol, max_step);
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org310372d" class="outline-3">
<h3 id="org310372d"><span class="section-number-3">3.8</span> ODE group  integrator Function</h3>
<div class="outline-text-3" id="text-3-8">
</div>
<div id="outline-container-org307a44f" class="outline-4">
<h4 id="org307a44f"><span class="section-number-4">3.8.1</span> Description</h4>
<div class="outline-text-4" id="text-3-8-1">
<p>
All the preivous functions solves for a single ODE system. Torsten also
provides group modeling counterparts for ODE integrators. The
functions solve for a group of ODE systems that share an ODE RHS but with
different parameters. They have similar
signatures to single-ODE integration functions.
</p>
</div>
</div>
<div id="outline-container-orgf877b3f" class="outline-4">
<h4 id="orgf877b3f"><span class="section-number-4">3.8.2</span> Usage</h4>
<div class="outline-text-4" id="text-3-8-2">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">matrix</span> <span style="color: #268bd2;">pmx_integrate_ode_group_</span>[adams || rk45 || bdf](ODE_system, <span style="color: #b58900;">real</span>[ , ] y0, <span style="color: #b58900;">real</span> t0, <span style="color: #b58900;">int</span>[] len, <span style="color: #b58900;">real</span>[] ts, <span style="color: #b58900;">real</span>[ , ] theta, <span style="color: #b58900;">real</span>[ , ] x_r, <span style="color: #b58900;">int</span>[ , ] x_i, [ <span style="color: #b58900;">real</span> rtol, <span style="color: #b58900;">real</span> atol, <span style="color: #b58900;">int</span> max_step ] );
</pre>
</div>
<p>
Here <code class="src src-stan">[adams || rk45 || bdf]</code> indicates the
function name can be of any of the three suffixes. See section <a href="#sec:ode_func_note">sec:ode_func_note</a>.
</p>

<ul class="org-ul">
<li><code>ODE_rhs</code>
Function that specifies the right-hand-side \(f\). See Section <a href="#sec:ode_func_args">sec:ode_func_args</a>.</li>
<li><code>y0</code>
Initial condition \(y_0\) for each subsystem in the group. The
first dimension equals to the size of the group.</li>
<li><code>t0</code>
Initial time \(t_0\).</li>
<li><code>len</code>
A vector that contains the number of output time points for each
subsystem. The lenght of the vector equals to the size of the group.</li>
<li><code>ts</code>
Output time when solution is seeked, consisting of
<code>ts</code> of each subsystem concatenated.</li>
<li><code>theta</code>
2d-array parameters to be passed to <code>ODE_rhs</code>
function. Each row corresponds to one subsystem.</li>
<li><code>x_r</code>
2d-array real data to be passed to <code>ODE_rhs</code> function.
Each row corresponds to one subsystem.</li>
<li><code>x_i</code>
2d-array integer data to be passed to <code>ODE_rhs</code> function.
Each row corresponds to one subsystem.</li>
<li><code>rtol</code>
Relative tolerance.</li>
<li><code>atol</code>
Absolute tolerance.</li>
<li><code>max_step</code>
Maximum number of steps allowed between neighboring time in <code>ts</code>.</li>
</ul>
</div>
</div>

<div id="outline-container-org3e1e0f0" class="outline-4">
<h4 id="org3e1e0f0"><span class="section-number-4">3.8.3</span> Return value</h4>
<div class="outline-text-4" id="text-3-8-3">
<p>
An <code>n</code>-by-<code>nd</code> matrix, where <code>n</code> is the size of <code>ts</code>
and <code>nd</code> the dimension of the system.
</p>
</div>
</div>
<div id="outline-container-orgc5b1246" class="outline-4">
<h4 id="orgc5b1246"><span class="section-number-4">3.8.4</span> Note</h4>
<div class="outline-text-4" id="text-3-8-4">
<p>
\label{sec:ode_integ_group_note}
</p>
<ul class="org-ul">
<li>With optional arguments indicated by square bracket, the following calls are allowed:</li>
</ul>
<div class="org-src-container">
<pre class="src src-stan">pmx_integrate_group_[adams || rk45 || bdf](..., x_i);
pmx_integrate_group_[adams || rk45 || bdf](..., x_i, rel_tol, abs_tol, max_step);
</pre>
</div>
<ul class="org-ul">
<li>The group integrators support paralleisation through Message Passing
Interface(MPI). One can access this feature through <code>cmdstan</code> or
<code>cmdstanr</code> interface.</li>
</ul>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #586e75;"># </span><span style="color: #586e75;">cmdstan interface user need to add "TORSTEN_MPI=1" and</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">"TBB_CXX_TYPE=gcc" in "cmdstan/make/local" file. In linux &amp; macos</span>
<span style="color: #586e75;"># </span><span style="color: #586e75;">this can be done as</span>
<span style="color: #839496; font-weight: bold;">echo</span> <span style="color: #2aa198;">"TORSTEN_MPI=1"</span> &gt; cmdstan/make/local
<span style="color: #839496; font-weight: bold;">echo</span> <span style="color: #2aa198;">"TBB_CXX_TYPE=gcc"</span> &gt; cmdstan/make/local <span style="color: #586e75;"># </span><span style="color: #586e75;">"gcc" should be replaced by user's C compiler</span>
make path-to-model/model_name
mpiexec -n number_of_processes model_name sample... <span style="color: #586e75;"># </span><span style="color: #586e75;">additional cmdstan options</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-r"><span style="color: #268bd2; font-weight: bold;">library</span>(<span style="color: #2aa198;">"cmdstanr"</span>)
cmdstan_make_local(cpp_options = list(<span style="color: #2aa198;">"TORSTEN_MPI"</span> = <span style="color: #2aa198;">"1"</span>, <span style="color: #2aa198;">"TBB_CXX_TYPE"</span>=<span style="color: #2aa198;">"gcc"</span>))  <span style="color: #586e75;"># </span><span style="color: #586e75;">"gcc" should be replaced by user's C compiler</span>
rebuild_cmdstan()
mod <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cmdstan_model(path-to-model-file, quiet=<span style="color: #b58900;">FALSE</span>, force_recompile=<span style="color: #b58900;">TRUE</span>)
f <span style="color: #268bd2; font-weight: bold;">&lt;-</span> mod$sample_mpi(data = ..., chains = 1, mpi_args = list(<span style="color: #2aa198;">"n"</span> = number_of_processes), refresh = 200)
</pre>
</div>
<p>
Here \(n\) denotes number of MPI processes, so that \(N\)
ODE systems are distributed to and solved by \(n\)
processes evenly. Note that to access this feature user must have
MPI installed, and some MPI installation may require set additional
compiler arguments, such as <code>CXXLFAGS</code> and <code>LDFLAGS</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-org72a8ba7" class="outline-3">
<h3 id="org72a8ba7"><span class="section-number-3">3.9</span> Univariate integral</h3>
<div class="outline-text-3" id="text-3-9">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span> <span style="color: #268bd2;">univariate_integral_rk45</span>(f, t0, t1, theta, x_r, x_i)
</pre>
</div>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span> <span style="color: #268bd2;">univariate_integral_bdf</span>(f, t0, t1, theta, x_r, x_i)
</pre>
</div>
<p>
Based on the ODE solver capability in Stan, Torsten provides functions
calculating the integral of a univariate function. The integrand function \(f\) must follow the signature
</p>
<div class="org-src-container">
<pre class="src src-stan">  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">f</span>(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">real</span>[] theta, <span style="color: #b58900;">real</span>[] x_r, <span style="color: #b58900;">int</span>[] x_i) {
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">...</span><span style="color: #586e75;"> */</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb349cc" class="outline-3">
<h3 id="orgcb349cc"><span class="section-number-3">3.10</span> Piecewise linear interpolation</h3>
<div class="outline-text-3" id="text-3-10">
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span> <span style="color: #268bd2;">linear_interpolation</span>(<span style="color: #b58900;">real</span> xout, <span style="color: #b58900;">real</span>[] x, <span style="color: #b58900;">real</span>[] y)
</pre>
</div>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">linear_interpolation</span>(<span style="color: #b58900;">real</span>[] xout, <span style="color: #b58900;">real</span>[] x, <span style="color: #b58900;">real</span>[] y)
</pre>
</div>
<p>
Torsten also provides function <code>linear_interpolation</code> for piecewise linear interpolation over a
set of x, y pairs. It returns the values of a piecewise linear
function at specified values <code>xout</code> of the first function argument. The
function is specified in terms of a set of x, y
pairs. Specifically, <code>linear_interpolation</code> implements the following function
</p>
\begin{align*}
  y_{\text{out}} = \left\{\begin{array}{ll}
                 y_1, & x_{\text{out}} < x_1 \\
                 y_i + \frac{y_{i+1} - y_i}{x_{i+1} - x_i}
                 \left(x_{\text{out}} - x_i\right), & x_{\text{out}} \in [x_i, x_{i+1}) \\
                 y_n, & x_{\text{out}} \ge x_n 
                          \end{array}\right.
\end{align*}
<ul class="org-ul">
<li>The x values must be in increasing order, i.e. \(x_i < x_{i+1}\).</li>
<li>All three arguments may be data or parameters.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgff30706" class="outline-2">
<h2 id="orgff30706"><span class="section-number-2">4</span> Examples</h2>
<div class="outline-text-2" id="text-4">
<p>
All the PMX models in this chapter can be found in
<code>Torsten/example-models</code> directory:
</p>
<ul class="org-ul">
<li><code>Torsten/example-models/pk2cpt</code> (Section <a href="#sec:pk2cpt">sec:pk2cpt</a>).</li>
<li><code>Torsten/example-models/pk2cpt_linode</code> (Section <a href="#sec:pk2cpt_linode">sec:pk2cpt_linode</a>).</li>
<li><code>Torsten/example-models/pk2cpt_ode</code> (Section <a href="#sec:pk2cpt_ode">sec:pk2cpt_ode</a>).</li>
<li><code>Torsten/example-models/FK_coupled</code> (Section <a href="#sec:fk_model">sec:fk_model</a>).</li>
<li><code>Torsten/example-models/twocpt_population</code> (Section <a href="#sec:twocpt_population">sec:twocpt_population</a>).</li>
<li><code>Torsten/example-models/lotka_volterra_ode_group_model</code> (Section <a href="#sec:lotka_volterra">sec:lotka_volterra</a>).</li>
<li><code>Torsten/example-models/effCpt</code> (Section <a href="#sec:effcpt_model">sec:effcpt_model</a>).</li>
<li><code>Torsten/example-models/FribergKarlsson</code> (Section <a href="#sec:fkpop_model">sec:fkpop_model</a>).</li>
</ul>
</div>

<div id="outline-container-org9bfc9f9" class="outline-3">
<h3 id="org9bfc9f9"><span class="section-number-3">4.1</span> Two-compartment model for single patient</h3>
<div class="outline-text-3" id="text-4-1">
<p>
\label{sec:pk2cpt}
  We model drug absorption in a single patient and simulate plasma drug concentrations:
</p>

<ul class="org-ul">
<li>Multiple Doses: 1250 mg, every 12 hours, for a total of 15 doses</li>
<li>PK measured at 0.083, 0.167, 0.25, 0.5, 0.75, 1, 1.5, 2, 4, 6,
8, 10 and 12 hours after 1st, 2nd, and 15th dose. In addition, the
PK is measured every 12 hours throughout the trial.</li>
</ul>

<p>
With the plasma concentration \(\hat{c}\) solved from
two-compartment ODEs in <a href="#org2582672">3.2</a>, we simulate \(c\) according to:
</p>
\begin{align*}
  \log\left(c\right) &\sim N\left(\log\left(\widehat{c}\right),\sigma^2\right) \\
  \left(CL, Q, V_2, V_3, ka\right) &= \left(5\ {\rm L/h}, 8\  {\rm L/h}, 20\  {\rm L},  70\ {\rm L}, 1.2\ {\rm h^{-1}} \right) \\
  \sigma^2 &= 0.01
\end{align*}
<p>
The data are generated using the R package <code>mrgsolve</code> (<a href="#citeproc_bib_item_1">Baron and Gastonguay 2015</a>).
</p>

<p>
Code below shows how Torsten function <code>pmx_solve_twocpt</code> can be used to fit the above model.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of events</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of observation</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObs</span>[nObs];  <span style="color: #586e75;">// </span><span style="color: #586e75;">index of observation</span>

  <span style="color: #586e75;">// </span><span style="color: #586e75;">NONMEM data</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">evid</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">addl</span>[nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">ss</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">amt</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">time</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rate</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ii</span>[nt];

  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">observed concentration (Dependent Variable)</span>
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">vector</span>[nObs] logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  <span style="color: #b58900;">int</span> nTheta <span style="color: #268bd2; font-weight: bold;">=</span> 5;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of ODE parameters in Two Compartment Model</span>
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 3;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of compartments in model</span>
}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">theta</span>[nTheta];  <span style="color: #586e75;">// </span><span style="color: #586e75;">ODE parameters</span>
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">matrix</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nCmt, nt] <span style="color: #268bd2;">x</span>;

  theta[1] <span style="color: #268bd2; font-weight: bold;">=</span> CL;
  theta[2] <span style="color: #268bd2; font-weight: bold;">=</span> Q;
  theta[3] <span style="color: #268bd2; font-weight: bold;">=</span> V1;
  theta[4] <span style="color: #268bd2; font-weight: bold;">=</span> V2;
  theta[5] <span style="color: #268bd2; font-weight: bold;">=</span> ka;

  x <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_twocpt(time, amt, rate, ii, evid, cmt, addl, ss, theta);

  cHat <span style="color: #268bd2; font-weight: bold;">=</span> x[2, :] ./ V1; <span style="color: #586e75;">// </span><span style="color: #586e75;">we're interested in the amount in the second compartment</span>

  cHatObs <span style="color: #268bd2; font-weight: bold;">=</span> cHat'[iObs]; <span style="color: #586e75;">// </span><span style="color: #586e75;">predictions for observed data recors</span>
}

<span style="color: #859900; font-weight: bold;">model</span>{
  <span style="color: #586e75;">// </span><span style="color: #586e75;">informative prior</span>
  CL <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(10), 0.25);
  Q <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(15), 0.5);
  V1 <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(35), 0.25);
  V2 <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(105), 0.5);
  ka <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(2.5), 1);
  sigma <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

  logCObs <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(<span style="color: #268bd2;">log</span>(cHatObs), sigma);
}
</pre>
</div>

<p>
Four MCMC chains of 2000 iterations (1000 warmup iterations and 1000
sampling iterations) are simulated. 1000 samples per chain were used for the subsequent analyses.
The MCMC history plots(Figure <a href="#orgfafa07f">2</a>)
suggest that the 4 chains have converged to common distributions for
all of the key model parameters. The fit to the plasma concentration
data (Figure <a href="#orgc9773f4">4</a>) are in close agreement with the
data, which is not surprising since the fitted model is identical to
the one used to simulate the data. Similarly the parameter posterior
density can be examined in Figure <a href="#org61a768e">3</a> and shows
consistency with the values used for simulation. Another way to
summarize the posterior is through <code>cmdstanr</code>'s <code>summary</code> method.
</p>

<div class="org-src-container">
<pre class="src src-r"><span style="color: #586e75;">## </span><span style="color: #586e75;">fit is a CmdStanMCMC object returned by sampling. See cmdstanr reference.</span>
&gt; pars = c(<span style="color: #2aa198;">"CL"</span>, <span style="color: #2aa198;">"Q"</span>, <span style="color: #2aa198;">"V1"</span>, <span style="color: #2aa198;">"V2"</span>, <span style="color: #2aa198;">"ka"</span>, <span style="color: #2aa198;">"sigma"</span>)
&gt; fit$summary(pars)
<span style="color: #586e75;"># </span><span style="color: #586e75;">A tibble: 6 x 10</span>
  variable   mean median     sd    mad      q5    q95  rhat ess_bulk ess_tail
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 CL        4.82   4.83  0.0910 0.0870  4.68    4.97   1.00    1439.    1067.
2 Q         7.56   7.55  0.588  0.586   6.61    8.56   1.00    1256.    1235.
3 V1       21.1   21.1   2.50   2.45   17.1    25.3    1.00    1057.    1177.
4 V2       76.1   76.1   5.33   4.93   67.5    84.9    1.01    1585.    1372.
5 ka        1.23   1.23  0.175  0.174   0.958   1.52   1.00    1070.    1122.
6 sigma     0.109  0.108 0.0117 0.0111  0.0911  0.130  1.01    1414.     905.
</pre>
</div>

<p>
<a href="../example-models/pk2cpt/deliv/figure/history.pdf">../example-models/pk2cpt/deliv/figure/history.pdf</a>
</p>

<p>
<a href="../example-models/pk2cpt/deliv/figure/density.pdf">../example-models/pk2cpt/deliv/figure/density.pdf</a>
</p>

<p>
<a href="../example-models/pk2cpt/deliv/figure/ppc_ribbon.pdf">../example-models/pk2cpt/deliv/figure/ppc_ribbon.pdf</a>
</p>
</div>
</div>

<div id="outline-container-org3056f65" class="outline-3">
<h3 id="org3056f65"><span class="section-number-3">4.2</span> Two-compartment model as a linear ODE model for single patient</h3>
<div class="outline-text-3" id="text-4-2">
<p>
\label{sec:pk2cpt_linode}
Using <code>pmx_solve_linode</code>, the following example fits a two-compartment model
with first order absorption. We omit <code class="src src-stan">data</code> and
<code class="src src-stan">model</code> block as they are identical to Sectiontion <a href="#sec:pk2cpt">sec:pk2cpt</a>.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">row_vector</span>[nObs] logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 3;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[nCmt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[nCmt];

  <span style="color: #859900; font-weight: bold;">for</span> (i <span style="color: #859900; font-weight: bold;">in</span> 1:nCmt) {
    biovar[i] <span style="color: #268bd2; font-weight: bold;">=</span> 1;
    tlag[i] <span style="color: #268bd2; font-weight: bold;">=</span> 0;
  }
}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">matrix</span>[3, 3] <span style="color: #268bd2;">K</span>;
  <span style="color: #b58900;">real</span> k10 <span style="color: #268bd2; font-weight: bold;">=</span> CL / V1;
  <span style="color: #b58900;">real</span> k12 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V1;
  <span style="color: #b58900;">real</span> k21 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V2;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">matrix</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[3, nt] <span style="color: #268bd2;">x</span>;

  K <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_matrix</span>(0, 3, 3);

  K[1, 1] <span style="color: #268bd2; font-weight: bold;">=</span> -ka;
  K[2, 1] <span style="color: #268bd2; font-weight: bold;">=</span> ka;
  K[2, 2] <span style="color: #268bd2; font-weight: bold;">=</span> -(k10 + k12);
  K[2, 3] <span style="color: #268bd2; font-weight: bold;">=</span> k21;
  K[3, 2] <span style="color: #268bd2; font-weight: bold;">=</span> k12;
  K[3, 3] <span style="color: #268bd2; font-weight: bold;">=</span> -k21;

  x <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_linode(time, amt, rate, ii, evid, cmt, addl, ss, K, biovar, tlag);

  cHat <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">row</span>(x, 2) ./ V1;

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObs){
    cHatObs[i] <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObs[i]];  <span style="color: #586e75;">// </span><span style="color: #586e75;">predictions for observed data records</span>
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org682173d" class="outline-3">
<h3 id="org682173d"><span class="section-number-3">4.3</span> Two-compartment model solved by numerical integrator for single patient</h3>
<div class="outline-text-3" id="text-4-3">
<p>
\label{sec:pk2cpt_ode}
Using <code>pmx_solve_rk45</code>, the following example fits a two-compartment model
with first order absorption. User-defined function
<code>ode_rhs</code> describes the RHS of the ODEs. 
</p>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">functions</span>{
  <span style="color: #b58900;">vector</span> <span style="color: #268bd2;">ode_rhs</span>(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">vector</span> x, <span style="color: #b58900;">real</span>[] parms, <span style="color: #b58900;">real</span>[] x_r, <span style="color: #b58900;">int</span>[] x_i){
    <span style="color: #b58900;">real</span> CL <span style="color: #268bd2; font-weight: bold;">=</span> parms[1];
    <span style="color: #b58900;">real</span> Q <span style="color: #268bd2; font-weight: bold;">=</span> parms[2];
    <span style="color: #b58900;">real</span> V1 <span style="color: #268bd2; font-weight: bold;">=</span> parms[3];
    <span style="color: #b58900;">real</span> V2 <span style="color: #268bd2; font-weight: bold;">=</span> parms[4];
    <span style="color: #b58900;">real</span> ka <span style="color: #268bd2; font-weight: bold;">=</span> parms[5];

    <span style="color: #b58900;">real</span> k10 <span style="color: #268bd2; font-weight: bold;">=</span> CL / V1;
    <span style="color: #b58900;">real</span> k12 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V1;
    <span style="color: #b58900;">real</span> k21 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V2;

    <span style="color: #b58900;">vector</span>[3] <span style="color: #268bd2;">y</span>;

    y[1] <span style="color: #268bd2; font-weight: bold;">=</span> -ka*x[1];
    y[2] <span style="color: #268bd2; font-weight: bold;">=</span> ka*x[1] - (k10 + k12)*x[2] + k21*x[3];
    y[3] <span style="color: #268bd2; font-weight: bold;">=</span> k12*x[2] - k21*x[3];

    <span style="color: #859900; font-weight: bold;">return</span> y;
  }
}
</pre>
</div>

<p>
We omit <code class="src src-stan">data</code> and
<code class="src src-stan">model</code> block as they are identical to Section <a href="#sec:pk2cpt">sec:pk2cpt</a>.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">transformed data</span> {
  <span style="color: #b58900;">row_vector</span>[nObs] logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  <span style="color: #b58900;">int</span> nTheta <span style="color: #268bd2; font-weight: bold;">=</span> 5;   <span style="color: #586e75;">// </span><span style="color: #586e75;">number of parameters</span>
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 3;   <span style="color: #586e75;">// </span><span style="color: #586e75;">number of compartments</span>
}

<span style="color: #859900; font-weight: bold;">parameters</span> {
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span> {
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">theta</span>[nTheta];
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">matrix</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[3, nt] <span style="color: #268bd2;">x</span>; 

  theta[1] <span style="color: #268bd2; font-weight: bold;">=</span> CL;
  theta[2] <span style="color: #268bd2; font-weight: bold;">=</span> Q;
  theta[3] <span style="color: #268bd2; font-weight: bold;">=</span> V1;
  theta[4] <span style="color: #268bd2; font-weight: bold;">=</span> V2;
  theta[5] <span style="color: #268bd2; font-weight: bold;">=</span> ka;

  x <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_rk45(ode_rhs, 3, time, amt, rate, ii, evid, cmt, addl, ss, theta, 1e-5, 1e-8, 1e5);

  cHat <span style="color: #268bd2; font-weight: bold;">=</span> x[2, ] ./ V1;

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObs){
    cHatObs[i] <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObs[i]];  <span style="color: #586e75;">// </span><span style="color: #586e75;">predictions for observed data records</span>
  }
}

<span style="color: #859900; font-weight: bold;">model</span>{
</pre>
</div>
</div>
</div>

<div id="outline-container-org57966d8" class="outline-3">
<h3 id="org57966d8"><span class="section-number-3">4.4</span> Joint PK-PD model</h3>
<div class="outline-text-3" id="text-4-4">
<p>
\label{sec:fk_model}
</p>
<p>
Neutropenia is observed in patients receiving an ME-2 drug. Our goal
is to model the relation between neutrophil counts and drug
exposure. As shown in Figure <a href="#fig:FK_model">fig:FK_model</a>, the Friberg-Karlsson Semi-Mechanistic model (<a href="#citeproc_bib_item_5">Friberg and Karlsson 2003</a>) couples
a PK model with a PD
effect to describe a delayed feedback mechanism that keeps the
absolute neutrophil count (ANC) at the
baseline in a circulatory compartment (Circ), and
the drug's effect in
reducing the proliferation rate (prol).
The delay between prol and Circ is modeled using \(n\) transit
comparments with mean transit time MTT = \((n + 1)/k_{\text{tr}}\),
with \(k_{\text{tr}}\) the transit rate constant. In the current example, we use the two compartment model in section <a href="#org2582672">3.2</a> for
PK model, and set \(n = 3\).
</p>

\begin{align}
  \log(\text{ANC})& \sim N(\log(y_{\text{circ}}), \sigma^2_{\text{ANC}}),  \\
  y_{\text{circ}}& = f_{\text{FK}}(\text{MTT}, \text{Circ}_{0}, \alpha, \gamma, c),
\end{align}
<p>
  where \(c\) is the drug concentration calculated from the PK model, and function \(f_{\text{FK}}\) represents solving the following
nonlinear ODE for \(y_{\text{circ}}\) 
</p>
\begin{subequations}
  \begin{align}
  \frac{dy_\mathrm{prol}}{dt} &= k_\mathrm{prol} y_\mathrm{prol} (1 - E_\mathrm{drug})\left(\frac{\text{Circ}_0}{y_\mathrm{circ}}\right)^\gamma - k_\mathrm{tr}y_\mathrm{prol}, \\
  \frac{dy_\mathrm{trans1}}{dt} &= k_\mathrm{tr} y_\mathrm{prol} - k_\mathrm{tr} y_\mathrm{trans1}, \\
  \frac{dy_\mathrm{trans2}}{dt} &= k_\mathrm{tr} y_\mathrm{trans1} - k_\mathrm{tr} y_\mathrm{trans2},  \\
  \frac{dy_\mathrm{trans3}}{dt} &= k_\mathrm{tr} y_\mathrm{trans2} - k_\mathrm{tr} y_\mathrm{trans3},  \\
  \frac{dy_\mathrm{circ}}{dt} &= k_\mathrm{tr} y_\mathrm{trans3} - k_\mathrm{tr} y_\mathrm{circ},
   \label{eq:FK}
  \end{align}
\end{subequations}
<p>
We use \(E_{\text{drug}} = \alpha c\) to model the linear effect of drug
concentration in central compartment, with
\(c=y_{\text{cent}}/V_{\text{cent}}\) based on PK solutions.
</p>

<p>
Since the ODEs specifying the Two Compartment Model
(Equation \eqref{eq:twocpt}) do not depend on the PD ODEs
(Equation \eqref{eq:FK}) and can be solved analytically
using Torsten's <code class="src src-stan">pmx_solve_twocpt</code> function
we can specify solve the system using a coupled solver function. We do not
expect our system to be stiff and use the Runge-Kutta 4th/5th order
integrator.
</p>


<div id="orgb7640ce" class="figure">
<p><img src="./graphics/neutrophilModel.jpg" alt="neutrophilModel.jpg" />
</p>
<p><span class="figure-number">Figure 2: </span>Friberg-Karlsson semi-mechanistic Model.</p>
</div>

<p>
The model fitting is based on simulated data
</p>
\begin{align*}
  (\text{MTT}, \text{Circ}_{0}, \alpha, \gamma, k_{\text{tr}})& = (125, 5.0, 3 \times 10^{-4}, 0.17) \\
  \sigma^2_{\text{ANC}}& = 0.001.
\end{align*}

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">functions</span>{
  <span style="color: #b58900;">vector</span> <span style="color: #268bd2;">FK_ODE</span>(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">vector</span> y, <span style="color: #b58900;">vector</span> y_pk, <span style="color: #b58900;">real</span>[] theta, <span style="color: #b58900;">real</span>[] rdummy, <span style="color: #b58900;">int</span>[] idummy){
    <span style="color: #586e75;">/* </span><span style="color: #586e75;">PK variables</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">real</span> VC <span style="color: #268bd2; font-weight: bold;">=</span> theta[3];

    <span style="color: #586e75;">/* </span><span style="color: #586e75;">PD variable</span><span style="color: #586e75;"> */</span>
    <span style="color: #b58900;">real</span> mtt      <span style="color: #268bd2; font-weight: bold;">=</span> theta[6];
    <span style="color: #b58900;">real</span> circ0    <span style="color: #268bd2; font-weight: bold;">=</span> theta[7];
    <span style="color: #b58900;">real</span> alpha    <span style="color: #268bd2; font-weight: bold;">=</span> theta[8];
    <span style="color: #b58900;">real</span> gamma    <span style="color: #268bd2; font-weight: bold;">=</span> theta[9];
    <span style="color: #b58900;">real</span> ktr      <span style="color: #268bd2; font-weight: bold;">=</span> 4.0 / mtt;
    <span style="color: #b58900;">real</span> prol     <span style="color: #268bd2; font-weight: bold;">=</span> y[1] + circ0;
    <span style="color: #b58900;">real</span> transit1 <span style="color: #268bd2; font-weight: bold;">=</span> y[2] + circ0;
    <span style="color: #b58900;">real</span> transit2 <span style="color: #268bd2; font-weight: bold;">=</span> y[3] + circ0;
    <span style="color: #b58900;">real</span> transit3 <span style="color: #268bd2; font-weight: bold;">=</span> y[4] + circ0;
    <span style="color: #b58900;">real</span> circ     <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">fmax</span>(machine_precision(), y[5] + circ0);
    <span style="color: #b58900;">real</span> conc     <span style="color: #268bd2; font-weight: bold;">=</span> y_pk[2] / VC;
    <span style="color: #b58900;">real</span> EDrug    <span style="color: #268bd2; font-weight: bold;">=</span> alpha * conc;

    <span style="color: #b58900;">vector</span>[5] <span style="color: #268bd2;">dydt</span>;

    dydt[1] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * prol * ((1 - EDrug) * ((circ0 / circ)^gamma) - 1);
    dydt[2] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (prol - transit1);
    dydt[3] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit1 - transit2);
    dydt[4] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit2 - transit3);
    dydt[5] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit3 - circ);

    <span style="color: #859900; font-weight: bold;">return</span> dydt;
  }
}

<span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObsPK</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObsPD</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObsPK</span>[nObsPK];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObsPD</span>[nObsPD];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">amt</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">evid</span>[nt];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">time</span>[nt];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ii</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">addl</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ss</span>[nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rate</span>[nt];
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPK] <span style="color: #268bd2;">cObs</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPD] <span style="color: #268bd2;">neutObs</span>;

  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">circ0Prior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">circ0PriorCV</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">mttPrior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">mttPriorCV</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">gammaPrior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">gammaPriorCV</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">alphaPrior</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">alphaPriorCV</span>;
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">int</span> nOde <span style="color: #268bd2; font-weight: bold;">=</span> 5;
  <span style="color: #b58900;">vector</span>[nObsPK] <span style="color: #268bd2;">logCObs</span>;
  <span style="color: #b58900;">vector</span>[nObsPD] <span style="color: #268bd2;">logNeutObs</span>;

  <span style="color: #b58900;">int</span> nTheta <span style="color: #268bd2; font-weight: bold;">=</span> 9; <span style="color: #586e75;">// </span><span style="color: #586e75;">number of parameters</span>
  <span style="color: #b58900;">int</span> nIIV <span style="color: #268bd2; font-weight: bold;">=</span> 7; <span style="color: #586e75;">// </span><span style="color: #586e75;">parameters with IIV</span>

  <span style="color: #b58900;">int</span> n <span style="color: #268bd2; font-weight: bold;">=</span> 8;                        <span style="color: #586e75;">/* </span><span style="color: #586e75;">ODE dimension</span><span style="color: #586e75;"> */</span>
  <span style="color: #b58900;">real</span> rtol <span style="color: #268bd2; font-weight: bold;">=</span> 1e-8;
  <span style="color: #b58900;">real</span> atol <span style="color: #268bd2; font-weight: bold;">=</span> 1e-8;;
  <span style="color: #b58900;">int</span> max_step <span style="color: #268bd2; font-weight: bold;">=</span> 100000;

  logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  logNeutObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(neutObs);
}

<span style="color: #859900; font-weight: bold;">parameters</span>{

  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">VC</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">VP</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">mtt</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">circ0</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">alpha</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">gamma</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigmaNeut</span>;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">IIV parameters</span>
  <span style="color: #b58900;">cholesky_factor_corr</span>[nIIV] <span style="color: #268bd2;">L</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nIIV] <span style="color: #268bd2;">omega</span>;
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">row_vector</span>[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPK] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">row_vector</span>[nt] <span style="color: #268bd2;">neutHat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObsPD] <span style="color: #268bd2;">neutHatObs</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">theta</span>[nTheta];
  <span style="color: #b58900;">matrix</span>[nOde + 3, nt] <span style="color: #268bd2;">x</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[nTheta] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_array</span>(1.0, nTheta);
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[nTheta] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_array</span>(0.0, nTheta);

  theta[1] <span style="color: #268bd2; font-weight: bold;">=</span> CL;
  theta[2] <span style="color: #268bd2; font-weight: bold;">=</span> Q;
  theta[3] <span style="color: #268bd2; font-weight: bold;">=</span> VC;
  theta[4] <span style="color: #268bd2; font-weight: bold;">=</span> VP;
  theta[5] <span style="color: #268bd2; font-weight: bold;">=</span> ka;
  theta[6] <span style="color: #268bd2; font-weight: bold;">=</span> mtt;
  theta[7] <span style="color: #268bd2; font-weight: bold;">=</span> circ0;
  theta[8] <span style="color: #268bd2; font-weight: bold;">=</span> alpha;
  theta[9] <span style="color: #268bd2; font-weight: bold;">=</span> gamma;

  x <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_twocpt_rk45(FK_ODE, nOde, time, amt, rate, ii, evid, cmt, addl, ss, theta, biovar, tlag, rtol, atol, max_step);

  cHat <span style="color: #268bd2; font-weight: bold;">=</span> x[2, ] / VC;
  neutHat <span style="color: #268bd2; font-weight: bold;">=</span> x[8, ] + circ0;

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObsPK) cHatObs[i]    <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObsPK[i]];
  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObsPD) neutHatObs[i] <span style="color: #268bd2; font-weight: bold;">=</span> neutHat[iObsPD[i]];
}

<span style="color: #859900; font-weight: bold;">model</span> {
  <span style="color: #586e75;">// </span><span style="color: #586e75;">Priors</span>
  CL    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 20);
  Q     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 20);
  VC    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 100);
  VP    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 1000);
  ka    <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 5);
  sigma <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

  mtt       <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(mttPrior), mttPriorCV);
  circ0     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(circ0Prior), circ0PriorCV);
  alpha     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(alphaPrior), alphaPriorCV);
  gamma     <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(gammaPrior), gammaPriorCV);
  sigmaNeut <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

  <span style="color: #586e75;">// </span><span style="color: #586e75;">Parameters for Matt's trick</span>
  L <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lkj_corr_cholesky</span>(1);
  omega <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

  <span style="color: #586e75;">// </span><span style="color: #586e75;">observed data likelihood</span>
  logCObs <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(<span style="color: #268bd2;">log</span>(cObs), sigma);
  logNeutObs <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(<span style="color: #268bd2;">log</span>(neutObs), sigmaNeut);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbd36df0" class="outline-3">
<h3 id="orgbd36df0"><span class="section-number-3">4.5</span> Two-compartment population model</h3>
<div class="outline-text-3" id="text-4-5">
<p>
\label{sec:twocpt_population}
Using <code>pmx_solve_group_bdf</code>, the following example fits a
two-compartment population model.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">functions</span>{

  <span style="color: #586e75;">// </span><span style="color: #586e75;">define ODE system for two compartmnt model</span>
  <span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">twoCptModelODE</span>(<span style="color: #b58900;">real</span> t,
                        <span style="color: #b58900;">real</span>[] x,
                        <span style="color: #b58900;">real</span>[] parms,
                        <span style="color: #b58900;">real</span>[] rate,  <span style="color: #586e75;">// </span><span style="color: #586e75;">in this example, rate is treated as data</span>
                        <span style="color: #b58900;">int</span>[] dummy){

    <span style="color: #586e75;">// </span><span style="color: #586e75;">Parameters</span>
    <span style="color: #b58900;">real</span> CL <span style="color: #268bd2; font-weight: bold;">=</span> parms[1];
    <span style="color: #b58900;">real</span> Q <span style="color: #268bd2; font-weight: bold;">=</span> parms[2];
    <span style="color: #b58900;">real</span> V1 <span style="color: #268bd2; font-weight: bold;">=</span> parms[3];
    <span style="color: #b58900;">real</span> V2 <span style="color: #268bd2; font-weight: bold;">=</span> parms[4];
    <span style="color: #b58900;">real</span> ka <span style="color: #268bd2; font-weight: bold;">=</span> parms[5];

    <span style="color: #586e75;">// </span><span style="color: #586e75;">Re-parametrization</span>
    <span style="color: #b58900;">real</span> k10 <span style="color: #268bd2; font-weight: bold;">=</span> CL / V1;
    <span style="color: #b58900;">real</span> k12 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V1;
    <span style="color: #b58900;">real</span> k21 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V2;

    <span style="color: #586e75;">// </span><span style="color: #586e75;">Return object (derivative)</span>
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">y</span>[3];  <span style="color: #586e75;">// </span><span style="color: #586e75;">1 element per compartment of</span>
                <span style="color: #586e75;">// </span><span style="color: #586e75;">the model</span>

    <span style="color: #586e75;">// </span><span style="color: #586e75;">PK component of the ODE system</span>
    y[1] <span style="color: #268bd2; font-weight: bold;">=</span> -ka*x[1];
    y[2] <span style="color: #268bd2; font-weight: bold;">=</span> ka*x[1] - (k10 + k12)*x[2] + k21*x[3];
    y[3] <span style="color: #268bd2; font-weight: bold;">=</span> k12*x[2] - k21*x[3];

    <span style="color: #859900; font-weight: bold;">return</span> y;
  }
}
<span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">np</span>;            <span style="color: #586e75;">/* </span><span style="color: #586e75;">population size</span><span style="color: #586e75;"> */</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of events</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObs</span>;  <span style="color: #586e75;">// </span><span style="color: #586e75;">number of observations</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObs</span>[nObs];  <span style="color: #586e75;">// </span><span style="color: #586e75;">index of observation</span>

  <span style="color: #586e75;">// </span><span style="color: #586e75;">NONMEM data</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[np * nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">evid</span>[np * nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">addl</span>[np * nt];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">ss</span>[np * nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">amt</span>[np * nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">time</span>[np * nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">rate</span>[np * nt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ii</span>[np * nt];

  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">cObs</span>[np*nObs];  <span style="color: #586e75;">// </span><span style="color: #586e75;">observed concentration (dependent variable)</span>
}

<span style="color: #859900; font-weight: bold;">transformed data</span> {
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">logCObs</span>[np*nObs];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">len</span>[np];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">len_theta</span>[np];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">len_biovar</span>[np];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">len_tlag</span>[np];

  <span style="color: #b58900;">int</span> nTheta <span style="color: #268bd2; font-weight: bold;">=</span> 5;   <span style="color: #586e75;">// </span><span style="color: #586e75;">number of parameters</span>
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 3;   <span style="color: #586e75;">// </span><span style="color: #586e75;">number of compartments</span>
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[np * nt, nCmt];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[np * nt, nCmt];

  logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);

  <span style="color: #859900; font-weight: bold;">for</span> (id <span style="color: #859900; font-weight: bold;">in</span> 1:np) {
    <span style="color: #859900; font-weight: bold;">for</span> (j <span style="color: #859900; font-weight: bold;">in</span> 1:nt) {
      <span style="color: #859900; font-weight: bold;">for</span> (i <span style="color: #859900; font-weight: bold;">in</span> 1:nCmt) {
        biovar[(id - 1) * nt + j, i] <span style="color: #268bd2; font-weight: bold;">=</span> 1;
        tlag[(id - 1) * nt + j, i] <span style="color: #268bd2; font-weight: bold;">=</span> 0;
      }
    }
    len[id] <span style="color: #268bd2; font-weight: bold;">=</span> nt;
    len_theta[id] <span style="color: #268bd2; font-weight: bold;">=</span> nt;
    len_biovar[id] <span style="color: #268bd2; font-weight: bold;">=</span> nt;
    len_tlag[id] <span style="color: #268bd2; font-weight: bold;">=</span> nt;
  }
}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>[np];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>[np];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>[np];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>[np];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>[np];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>[np];
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">theta</span>[np * nt, nTheta];
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>[np];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">cHatObs</span>[np*nObs];
  <span style="color: #b58900;">matrix</span>[3, nt * np] <span style="color: #268bd2;">x</span>; 

  <span style="color: #859900; font-weight: bold;">for</span> (id <span style="color: #859900; font-weight: bold;">in</span> 1:np) {
    <span style="color: #859900; font-weight: bold;">for</span> (it <span style="color: #859900; font-weight: bold;">in</span> 1:nt) {
      theta[(id - 1) * nt + it, 1] <span style="color: #268bd2; font-weight: bold;">=</span> CL[id];
      theta[(id - 1) * nt + it, 2] <span style="color: #268bd2; font-weight: bold;">=</span> Q[id];
      theta[(id - 1) * nt + it, 3] <span style="color: #268bd2; font-weight: bold;">=</span> V1[id];
      theta[(id - 1) * nt + it, 4] <span style="color: #268bd2; font-weight: bold;">=</span> V2[id];
      theta[(id - 1) * nt + it, 5] <span style="color: #268bd2; font-weight: bold;">=</span> ka[id];
    }
  }

  x <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_group_bdf(twoCptModelODE, 3, len,
                          time, amt, rate, ii, evid, cmt, addl, ss,
                          theta, biovar, tlag);

  <span style="color: #859900; font-weight: bold;">for</span> (id <span style="color: #859900; font-weight: bold;">in</span> 1:np) {
    <span style="color: #859900; font-weight: bold;">for</span> (j <span style="color: #859900; font-weight: bold;">in</span> 1:nt) {
      cHat[id][j] <span style="color: #268bd2; font-weight: bold;">=</span> x[2, (id - 1) * nt + j] ./ V1[id];
    }
  }

  <span style="color: #859900; font-weight: bold;">for</span> (id <span style="color: #859900; font-weight: bold;">in</span> 1:np) {
    <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObs){
      cHatObs[(id - 1)*nObs + i] <span style="color: #268bd2; font-weight: bold;">=</span> cHat[id][iObs[i]];  <span style="color: #586e75;">// </span><span style="color: #586e75;">predictions for observed data records</span>
    }
  }
}

<span style="color: #859900; font-weight: bold;">model</span>{
  <span style="color: #586e75;">// </span><span style="color: #586e75;">informative prior</span>
  <span style="color: #859900; font-weight: bold;">for</span>(id <span style="color: #859900; font-weight: bold;">in</span> 1:np){
    CL[id] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(10), 0.25);
    Q[id] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(15), 0.5);
    V1[id] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(35), 0.25);
    V2[id] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(105), 0.5);
    ka[id] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(2.5), 1);
    sigma[id] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">cauchy</span>(0, 1);

    <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObs){
      logCObs[(id - 1)*nObs + i] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(<span style="color: #268bd2;">log</span>(cHatObs[(id - 1)*nObs + i]), sigma[id]);
    }
  }
}
</pre>
</div>

<p>
When the above model is compiled with MPI support(see Section
<a href="#sec:mpi_support">sec:mpi_support</a>), one can run it with within-chain
parallelization:
</p>
<div class="org-src-container">
<pre class="src src-bash">mpiexec -n nproc ./twocpt_population sample data <span style="color: #268bd2;">file</span>=twocpt_population.data.R <span style="color: #268bd2;">init</span>=twocpt_population.init.R
</pre>
</div>
<p>
Here <code class="src src-sh">nproc</code> indicates the number of parallel
processes participating ODE solution. For example, with
<code class="src src-stan">np<span style="color: #268bd2; font-weight: bold;">=</span>8</code> for a population of 8,
<code class="src src-sh"><span style="color: #268bd2;">nproc</span>=4</code> indicates solving 8 subjects' ODEs in
parallel, with each process solving 2 subjects.
</p>
</div>
</div>

<div id="outline-container-orgc3994c9" class="outline-3">
<h3 id="orgc3994c9"><span class="section-number-3">4.6</span> Lotka-Volterra group model</h3>
<div class="outline-text-3" id="text-4-6">
<p>
\label{sec:lotka_volterra}
Using <code>pmx_integrate_ode_group_rk45</code>, the following example fits
a Lotka-Volterra group model, based on <a href="https://mc-stan.org/users/documentation/case-studies/lotka-volterra-predator-prey.html">Stan's case study</a>.
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">functions</span> {
  <span style="color: #b58900;">real</span>[] <span style="color: #268bd2;">dz_dt</span>(<span style="color: #b58900;">real</span> t,       <span style="color: #586e75;">// </span><span style="color: #586e75;">time</span>
               <span style="color: #b58900;">real</span>[] z,     <span style="color: #586e75;">// </span><span style="color: #586e75;">system state {prey, predator}</span>
               <span style="color: #b58900;">real</span>[] theta, <span style="color: #586e75;">// </span><span style="color: #586e75;">parameters</span>
               <span style="color: #b58900;">real</span>[] x_r,   <span style="color: #586e75;">// </span><span style="color: #586e75;">unused data</span>
               <span style="color: #b58900;">int</span>[] x_i) {
    <span style="color: #b58900;">real</span> u <span style="color: #268bd2; font-weight: bold;">=</span> z[1];
    <span style="color: #b58900;">real</span> v <span style="color: #268bd2; font-weight: bold;">=</span> z[2];

    <span style="color: #b58900;">real</span> alpha <span style="color: #268bd2; font-weight: bold;">=</span> theta[1];
    <span style="color: #b58900;">real</span> beta <span style="color: #268bd2; font-weight: bold;">=</span> theta[2];
    <span style="color: #b58900;">real</span> gamma <span style="color: #268bd2; font-weight: bold;">=</span> theta[3];
    <span style="color: #b58900;">real</span> delta <span style="color: #268bd2; font-weight: bold;">=</span> theta[4];

    <span style="color: #b58900;">real</span> du_dt <span style="color: #268bd2; font-weight: bold;">=</span> (alpha - beta * v) * u;
    <span style="color: #b58900;">real</span> dv_dt <span style="color: #268bd2; font-weight: bold;">=</span> (-gamma + delta * u) * v;
    <span style="color: #859900; font-weight: bold;">return</span> { du_dt, dv_dt };
  }
}
<span style="color: #859900; font-weight: bold;">data</span> {
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">N_subj</span>;      <span style="color: #586e75;">// </span><span style="color: #586e75;">number of subjects</span>
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">N</span>;           <span style="color: #586e75;">// </span><span style="color: #586e75;">number of measurement times</span>
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ts_0</span>[N];                 <span style="color: #586e75;">// </span><span style="color: #586e75;">measurement times &gt; 0</span>
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">y0_0</span>[2];     <span style="color: #586e75;">// </span><span style="color: #586e75;">initial measured populations</span>
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">y_0</span>[N, 2];    <span style="color: #586e75;">// </span><span style="color: #586e75;">measured populations</span>
}
<span style="color: #859900; font-weight: bold;">transformed data</span> {
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">len</span>[N_subj] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_array</span>(N, N_subj);
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">y0</span>[N_subj, 2] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_array</span>(y0_0, N_subj);
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">y</span>[N_subj, N, 2] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_array</span>(y_0, N_subj);
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ts</span>[N_subj * N];
  <span style="color: #859900; font-weight: bold;">for</span> (i <span style="color: #859900; font-weight: bold;">in</span> 1:N_subj) {
    ts[((i-1)*N + 1) : (i*N)] <span style="color: #268bd2; font-weight: bold;">=</span> ts_0;
  }
}

<span style="color: #859900; font-weight: bold;">parameters</span> {
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">theta</span>[N_subj, 4];   <span style="color: #586e75;">// </span><span style="color: #586e75;">{ alpha, beta, gamma, delta }</span>
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">z_init</span>[N_subj, 2];  <span style="color: #586e75;">// </span><span style="color: #586e75;">initial population</span>
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>[N_subj, 2];   <span style="color: #586e75;">// </span><span style="color: #586e75;">measurement errors</span>
}
<span style="color: #859900; font-weight: bold;">transformed parameters</span> {
  <span style="color: #b58900;">matrix</span>[2, N_subj * N] <span style="color: #268bd2;">z</span>;
  z <span style="color: #268bd2; font-weight: bold;">=</span> pmx_integrate_ode_group_rk45(dz_dt, z_init, 0, len, ts, theta, <span style="color: #268bd2;">rep_array</span>(<span style="color: #268bd2;">rep_array</span>(0.0, 0), N_subj), <span style="color: #268bd2;">rep_array</span>(<span style="color: #268bd2;">rep_array</span>(0, 0),N_subj));
}
<span style="color: #859900; font-weight: bold;">model</span> {
  <span style="color: #859900; font-weight: bold;">for</span> (isub <span style="color: #859900; font-weight: bold;">in</span> 1:N_subj) {
    theta[isub, {1, 3}] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(1, 0.5);
    theta[isub, {2, 4}] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0.05, 0.05);
    sigma[isub] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(-1, 1);
    z_init[isub] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(10, 1);
    <span style="color: #859900; font-weight: bold;">for</span> (k <span style="color: #859900; font-weight: bold;">in</span> 1:2) {
      y0[isub, k] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(z_init[isub, k]), sigma[isub, k]);
      y[isub, , k] <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(z[k, ((isub-1)*N + 1):(isub*N)]), sigma[isub, k]);
    }
  }
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfd2f3d0" class="outline-3">
<h3 id="orgfd2f3d0"><span class="section-number-3">4.7</span> Univariate integral of a quadratic function</h3>
<div class="outline-text-3" id="text-4-7">
<p>
integral of a quadratic function.
This example shows how to use <code>univariate_integral_rk45</code> to calculate the
integral of a quadratic function.
</p>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">functions</span> {
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">fun_ord2</span>(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">real</span>[] theta, <span style="color: #b58900;">real</span>[] x_r, <span style="color: #b58900;">int</span>[] x_i) {
    <span style="color: #b58900;">real</span> a <span style="color: #268bd2; font-weight: bold;">=</span> 2.3;
    <span style="color: #b58900;">real</span> b <span style="color: #268bd2; font-weight: bold;">=</span> 2.0;
    <span style="color: #b58900;">real</span> c <span style="color: #268bd2; font-weight: bold;">=</span> 1.5;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">res</span>;
    res <span style="color: #268bd2; font-weight: bold;">=</span> a + b * t + c * t * t;
    <span style="color: #859900; font-weight: bold;">return</span> res;
  }
}
<span style="color: #859900; font-weight: bold;">data</span> {
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">t0</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">t1</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">dtheta</span>[2];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">x_r</span>[0];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">x_i</span>[0];
}
<span style="color: #859900; font-weight: bold;">transformed data</span> {
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">univar_integral</span>;
  univar_integral <span style="color: #268bd2; font-weight: bold;">=</span> univariate_integral_rk45(func, t0, t1, dtheta, 
                          x_r, x_i);
}
<span style="color: #586e75;">/* </span><span style="color: #586e75;">...</span><span style="color: #586e75;"> */</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b4fdff" class="outline-3">
<h3 id="org7b4fdff"><span class="section-number-3">4.8</span> Linear intepolation</h3>
<div class="outline-text-3" id="text-4-8">
<p>
This example illustrates how to use <code>linear_intepolationi</code>
to fit a piecewise linear function to a data set consisting
of \((x, y)\) pairs.
</p>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nObs</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">xObs</span>[nObs];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">yObs</span>[nObs];
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nx</span>;
  <span style="color: #b58900;">int</span> <span style="color: #268bd2;">nPred</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">xPred</span>[nPred];
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">real</span> xmin <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">min</span>(xObs);
  <span style="color: #b58900;">real</span> xmax <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">max</span>(xObs);
}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">y</span>[nx];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
  <span style="color: #b58900;">simplex</span>[nx - 1] <span style="color: #268bd2;">xSimplex</span>;
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">yHat</span>[nObs];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">x</span>[nx];

  x[1] <span style="color: #268bd2; font-weight: bold;">=</span> xmin;
  x[nx] <span style="color: #268bd2; font-weight: bold;">=</span> xmax;
  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 2:(nx-1))
    x[i] <span style="color: #268bd2; font-weight: bold;">=</span> x[i-1] + xSimplex[i-1] * (xmax - xmin);

  yHat <span style="color: #268bd2; font-weight: bold;">=</span> linear_interpolation(xObs, x, y);
}

<span style="color: #859900; font-weight: bold;">model</span>{
  xSimplex <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">dirichlet</span>(<span style="color: #268bd2;">rep_vector</span>(1, nx - 1));
  y <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 25);
  yObs <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(yHat, sigma);
}

<span style="color: #859900; font-weight: bold;">generated quantities</span>{
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">yHatPred</span>[nPred];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">yPred</span>[nPred];

  yHatPred <span style="color: #268bd2; font-weight: bold;">=</span> linear_interpolation(xPred, x, y);
  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nPred)
    yPred[i] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">normal_rng</span>(yHatPred[i], sigma);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org46d998d" class="outline-3">
<h3 id="org46d998d"><span class="section-number-3">4.9</span> Effect Compartment Population Model</h3>
<div class="outline-text-3" id="text-4-9">
<p>
\label{sec:effcpt_model}
Here we expand the example in <a href="#org2582672">3.2</a> to a population model fitted to the
combined data from phase I and phase IIa studies. The
parameters exhibit inter-individual variations (IIV), due to
both random effects and to the patients' body weight,
treated as a covariate and denoted \(bw\).
</p>
</div>
<div id="outline-container-orgc8b5e5e" class="outline-4">
<h4 id="orgc8b5e5e"><span class="section-number-4">4.9.1</span> Population Model for Plasma Drug Concentration \(c\)</h4>
<div class="outline-text-4" id="text-4-9-1">
\begin{gather*}
  \log\left(c_{ij}\right) \sim N\left(\log\left(\widehat{c}_{ij}\right),\sigma^2\right), \\
  \widehat{c}_{ij} = f_{2cpt}\left(t_{ij},D_j,\tau_j,CL_j,Q_j,V_{1j},V_{2j},k_{aj}\right), \\
  \log\left(CL_j,Q_j,V_{ssj},k_{aj}\right) \sim N\left(\log\left(\widehat{CL}\left(\frac{bw_j}{70}\right)^{0.75},\widehat{Q}\left(\frac{bw_j}{70}\right)^{0.75}, \widehat{V}_{ss}\left(\frac{bw_j}{70}\right),\widehat{k}_a\right),\Omega\right), \\
  V_{1j} = f_{V_1}V_{ssj}, \\
  V_{2j} = \left(1 - f_{V_1}\right)V_{ssj}, \\
  \left(\widehat{CL},\widehat{Q},\widehat{V}_{ss},\widehat{k}_a, f_{V_1}\right) = \left(10\ {\rm L/h},15\  {\rm L/h},140\  {\rm L},2\ {\rm h^{-1}}, 0.25 \right), \\
  \Omega = \left(\begin{array}{cccc} 0.25^2 & 0 & 0 & 0 \\ 0 & 0.25^2 & 0 & 0 \\
                    0 & 0 & 0.25^2 & 0 \\ 0 & 0 & 0 & 0.25^2  \end{array}\right), \\
  \sigma = 0.1
\end{gather*}

<p>
Furthermore we add a fourth compartment in which we measure
a PD effect(Figure <a href="#orged7760e">3</a>).
</p>


<div id="orged7760e" class="figure">
<p><img src="./graphics/effCptModel.png" alt="effCptModel.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Effect Compartment Model</p>
</div>
</div>
</div>

<div id="outline-container-org2d3af3d" class="outline-4">
<h4 id="org2d3af3d"><span class="section-number-4">4.9.2</span> Effect Compartment Model for PD response \(R\).</h4>
<div class="outline-text-4" id="text-4-9-2">
\begin{gather*}
R_{ij} \sim N\left(\widehat{R}_{ij},\sigma_{R}^2\right), \\
\widehat{R}_{ij} = \frac{E_{max}c_{eij}}{EC_{50j} + c_{eij}}, \\
c_{e\cdot j}^\prime = k_{e0j}\left(c_{\cdot j} - c_{e\cdot j}\right), \\
\log\left(EC_{50j}, k_{e0j}\right) \sim N\left(\log\left(\widehat{EC}_{50}, \widehat{k}_{e0}\right),\Omega_R\right), \\
\left(E_{max}, \widehat{EC}_{50},\widehat{k}_{e0}\right) = \left(100, 100.7, 1\right), \\
\Omega_R = \left(\begin{array}{cc} 0.2^2 & 0 \\ 0 & 0.25^2  \end{array}\right), \ \ \ \sigma_R = 10.
\end{gather*}

<p>
The PK and the PD data are simulated using the following
treatment.
</p>
<ul class="org-ul">
<li>Phase I study
<ul class="org-ul">
<li>Single dose and multiple doses</li>
<li>Parallel dose escalation design</li>
<li>25 subjects per dose</li>
<li>Single doses: 5, 10, 20, and 40 mg</li>
<li>PK: plasma concentration of parent drug (\(c\))</li>
<li>PD response: Emax function of effect compartment concentration (\(R\))</li>
<li>PK and PD measured at 0.125, 0.25, 0.5, 0.75, 1, 2, 3, 4, 6, 8, 12, 18, and 24 hours</li>
</ul></li>
<li>Phase IIa trial in patients
<ul class="org-ul">
<li>100 subjects</li>
<li>Multiple doses: 20 mg</li>
<li>sparse PK and PD data (3-6 samples per patient)</li>
</ul></li>
</ul>

<p>
The model is simultaneously fitted to the PK and the PD
data. For this effect compartment model, we construct a
constant rate matrix and use <code>pmx_solve_linode</code>. Correct use of
Torsten requires the user pass the entire event history
(observation and dosing events) for an individual to the
function. Thus the Stan model shows the call to <code>pmx_solve_linode</code>
within a loop over the individual subjects rather than over
the individual observations. Note that the correlation matrix \(\rho\) does not explicitly appear
in the model, but it is used to construct \(\Omega\), which parametrizes
the PK IIV. 
</p>

<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">data</span>{
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nSubjects</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nt</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">nObs</span>;
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">iObs</span>[nObs];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">amt</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">cmt</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">evid</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">start</span>[nSubjects];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; <span style="color: #268bd2;">end</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">time</span>[nt];
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cObs</span>;
  <span style="color: #b58900;">vector</span>[nObs] <span style="color: #268bd2;">respObs</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">weight</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">rate</span>[nt];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ii</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">addl</span>[nt];
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ss</span>[nt];
}

<span style="color: #859900; font-weight: bold;">transformed data</span>{
  <span style="color: #b58900;">vector</span>[nObs] logCObs <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(cObs);
  <span style="color: #b58900;">int</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 1&gt; nRandom <span style="color: #268bd2; font-weight: bold;">=</span> 5;
  <span style="color: #b58900;">int</span> nCmt <span style="color: #268bd2; font-weight: bold;">=</span> 4;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">biovar</span>[nCmt] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_array</span>(1.0, nCmt);
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">tlag</span>[nCmt] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_array</span>(0.0, nCmt);
}

<span style="color: #859900; font-weight: bold;">parameters</span>{
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CLHat</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">QHat</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1Hat</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2Hat</span>;
  <span style="color: #586e75;">//  </span><span style="color: #586e75;">real&lt;lower = 0&gt; kaHat;</span>
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> (CLHat / V1Hat + QHat / V1Hat + QHat / V2Hat +
                <span style="color: #268bd2;">sqrt</span>((CLHat / V1Hat + QHat / V1Hat + QHat / V2Hat)^2 -
                     4 * CLHat / V1Hat * QHat / V2Hat)) / 2&gt; kaHat; <span style="color: #586e75;">// </span><span style="color: #586e75;">ka &gt; lambda_1</span>
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ke0Hat</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">EC50Hat</span>;
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nRandom] <span style="color: #268bd2;">omega</span>;
  <span style="color: #b58900;">corr_matrix</span>[nRandom] <span style="color: #268bd2;">rho</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">omegaKe0</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">omegaEC50</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigma</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">sigmaResp</span>;

  <span style="color: #586e75;">// </span><span style="color: #586e75;">reparameterization</span>
  <span style="color: #b58900;">vector</span>[nRandom] <span style="color: #268bd2;">logtheta_raw</span>[nSubjects];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">logKe0_raw</span>[nSubjects];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">logEC50_raw</span>[nSubjects];
}

<span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nRandom] <span style="color: #268bd2;">thetaHat</span>;
  <span style="color: #b58900;">cov_matrix</span>[nRandom] <span style="color: #268bd2;">Omega</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">CL</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">Q</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V1</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">V2</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ka</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">ke0</span>[nSubjects];
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">EC50</span>[nSubjects];
  <span style="color: #b58900;">matrix</span>[nCmt, nCmt] <span style="color: #268bd2;">K</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">k10</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">k12</span>;
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">k21</span>;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">respHat</span>;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nObs] <span style="color: #268bd2;">respHatObs</span>;
  <span style="color: #b58900;">row_vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nt] <span style="color: #268bd2;">ceHat</span>;
  <span style="color: #b58900;">matrix</span>[nCmt, nt] <span style="color: #268bd2;">x</span>;

  <span style="color: #b58900;">matrix</span>[nRandom, nRandom] <span style="color: #268bd2;">L</span>;
  <span style="color: #b58900;">vector</span>[nRandom] <span style="color: #268bd2;">logtheta</span>[nSubjects];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">logKe0</span>[nSubjects];
  <span style="color: #b58900;">real</span> <span style="color: #268bd2;">logEC50</span>[nSubjects];

  thetaHat[1] <span style="color: #268bd2; font-weight: bold;">=</span> CLHat;
  thetaHat[2] <span style="color: #268bd2; font-weight: bold;">=</span> QHat;
  thetaHat[3] <span style="color: #268bd2; font-weight: bold;">=</span> V1Hat;
  thetaHat[4] <span style="color: #268bd2; font-weight: bold;">=</span> V2Hat;
  thetaHat[5] <span style="color: #268bd2; font-weight: bold;">=</span> kaHat;

  Omega <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">quad_form_diag</span>(rho, omega); <span style="color: #586e75;">// </span><span style="color: #586e75;">diag_matrix(omega) * rho * diag_matrix(omega)</span>
  L <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">cholesky_decompose</span>(Omega);

  <span style="color: #859900; font-weight: bold;">for</span>(j <span style="color: #859900; font-weight: bold;">in</span> 1:nSubjects){
    logtheta[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(thetaHat) + L * logtheta_raw[j];
    logKe0[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(ke0Hat) + logKe0_raw[j] * omegaKe0;
    logEC50[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">log</span>(EC50Hat) + logEC50_raw[j] * omegaEC50;

    CL[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">exp</span>(logtheta[j, 1]) * (weight[j] / 70)^0.75;
    Q[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">exp</span>(logtheta[j, 2]) * (weight[j] / 70)^0.75;
    V1[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">exp</span>(logtheta[j, 3]) * weight[j] / 70;
    V2[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">exp</span>(logtheta[j, 4]) * weight[j] / 70;
    ka[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">exp</span>(logtheta[j, 5]);
    ke0[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">exp</span>(logKe0[j]);
    EC50[j] <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">exp</span>(logEC50[j]);

    k10 <span style="color: #268bd2; font-weight: bold;">=</span> CL[j] / V1[j];
    k12 <span style="color: #268bd2; font-weight: bold;">=</span> Q[j] / V1[j];
    k21 <span style="color: #268bd2; font-weight: bold;">=</span> Q[j] / V2[j];

    K <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">rep_matrix</span>(0, nCmt, nCmt);

    K[1, 1] <span style="color: #268bd2; font-weight: bold;">=</span> -ka[j];
    K[2, 1] <span style="color: #268bd2; font-weight: bold;">=</span> ka[j];
    K[2, 2] <span style="color: #268bd2; font-weight: bold;">=</span> -(k10 + k12);
    K[2, 3] <span style="color: #268bd2; font-weight: bold;">=</span> k21;
    K[3, 2] <span style="color: #268bd2; font-weight: bold;">=</span> k12;
    K[3, 3] <span style="color: #268bd2; font-weight: bold;">=</span> -k21;
    K[4, 2] <span style="color: #268bd2; font-weight: bold;">=</span> ke0[j];
    K[4, 4] <span style="color: #268bd2; font-weight: bold;">=</span> -ke0[j];

    x[, start[j]:end[j] ] <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_linode(time[start[j]:end[j]], amt[start[j]:end[j]],
                                             rate[start[j]:end[j]], ii[start[j]:end[j]],
                                             evid[start[j]:end[j]], cmt[start[j]:end[j]],
                                             addl[start[j]:end[j]], ss[start[j]:end[j]], K, biovar, tlag);

    cHat[start[j]:end[j]] <span style="color: #268bd2; font-weight: bold;">=</span> 1000 * x[2, start[j]:end[j]] ./ V1[j];
    ceHat[start[j]:end[j]] <span style="color: #268bd2; font-weight: bold;">=</span> 1000 * x[4, start[j]:end[j]] ./ V1[j];
    respHat[start[j]:end[j]] <span style="color: #268bd2; font-weight: bold;">=</span> 100 * ceHat[start[j]:end[j]] ./ 
       (EC50[j] + ceHat[start[j]:end[j]]);
  }

  cHatObs <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObs];
  respHatObs <span style="color: #268bd2; font-weight: bold;">=</span> respHat[iObs];
}

<span style="color: #859900; font-weight: bold;">model</span>{
  <span style="color: #586e75;">// </span><span style="color: #586e75;">Prior</span>
  CLHat <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(10), 0.2);
  QHat <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(15), 0.2);
  V1Hat <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(30), 0.2);
  V2Hat <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(100), 0.2);
  kaHat <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(5), 0.25);
  ke0Hat <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(10), 0.25);
  EC50Hat <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">lognormal</span>(<span style="color: #268bd2;">log</span>(1.0), 0.2);
  omega <span style="color: #268bd2; font-weight: bold;">~</span> <span style="color: #268bd2;">normal</span>(0, 0.2);
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b7998e" class="outline-4">
<h4 id="org5b7998e"><span class="section-number-4">4.9.3</span> Results</h4>
<div class="outline-text-4" id="text-4-9-3">
<p>
We use the same diagnosis tools as for the
previous examples. Table <a href="#effCptModelParms">effCptModelParms</a> summarises the
statistics and diagnostics of the parameters. In particular, <code>rhat</code>
for all parameters being close to 1.0 indicates convergence of the 4
chains. Figure <a href="#effcpt_mcmc_density">effcpt_mcmc_density</a> shows the posterior density of
the parameters.
</p>

<p>
Posterior prediction check (PPC) in Figure
<a href="#effcpt_ppc_5mg">effcpt_ppc_5mg</a>-<a href="#effcpt_ppc_study_2_20mg">effcpt_ppc_study_2_20mg</a> show that the fits to the plasma concentration
are in close agreement with the data, notably for the sparse data case (phase IIa study). The fits
to the PD data (Figure
<a href="#effcpt_ppc_resp_5mg">effcpt_ppc_resp_5mg</a>-<a href="#effcpt_ppc_resp_study_2_20mg">effcpt_ppc_resp_study_2_20mg</a>) look
reasonable considering data being more noisy so the model
produces larger credible intervals. Both the summary table and PPC
plots show that the estimated values of the
parameters are consistent with the values used to simulate the data.
</p>

<table id="orgadf8d15" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Summary of the MCMC simulations of the marginal posterior distributions of the model parameters for the effect compartment model example.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">variable</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">median</th>
<th scope="col" class="org-right">sd</th>
<th scope="col" class="org-right">mad</th>
<th scope="col" class="org-right">q5</th>
<th scope="col" class="org-right">q95</th>
<th scope="col" class="org-right">rhat</th>
<th scope="col" class="org-right">ess<sub>bulk</sub></th>
<th scope="col" class="org-right">ess<sub>tail</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CLHat</td>
<td class="org-right">10.121</td>
<td class="org-right">10.120</td>
<td class="org-right">0.195</td>
<td class="org-right">0.192</td>
<td class="org-right">9.797</td>
<td class="org-right">10.445</td>
<td class="org-right">1.007</td>
<td class="org-right">319.942</td>
<td class="org-right">630.619</td>
</tr>

<tr>
<td class="org-left">QHat</td>
<td class="org-right">14.858</td>
<td class="org-right">14.853</td>
<td class="org-right">0.347</td>
<td class="org-right">0.344</td>
<td class="org-right">14.301</td>
<td class="org-right">15.432</td>
<td class="org-right">1.000</td>
<td class="org-right">1106.126</td>
<td class="org-right">1712.821</td>
</tr>

<tr>
<td class="org-left">V1Hat</td>
<td class="org-right">34.493</td>
<td class="org-right">34.516</td>
<td class="org-right">1.004</td>
<td class="org-right">0.995</td>
<td class="org-right">32.814</td>
<td class="org-right">36.086</td>
<td class="org-right">1.004</td>
<td class="org-right">671.777</td>
<td class="org-right">1563.396</td>
</tr>

<tr>
<td class="org-left">V2Hat</td>
<td class="org-right">103.269</td>
<td class="org-right">103.291</td>
<td class="org-right">2.876</td>
<td class="org-right">2.878</td>
<td class="org-right">98.568</td>
<td class="org-right">108.019</td>
<td class="org-right">1.002</td>
<td class="org-right">1689.165</td>
<td class="org-right">2580.382</td>
</tr>

<tr>
<td class="org-left">kaHat</td>
<td class="org-right">1.968</td>
<td class="org-right">1.969</td>
<td class="org-right">0.076</td>
<td class="org-right">0.074</td>
<td class="org-right">1.843</td>
<td class="org-right">2.087</td>
<td class="org-right">1.001</td>
<td class="org-right">1204.531</td>
<td class="org-right">1747.427</td>
</tr>

<tr>
<td class="org-left">ke0Hat</td>
<td class="org-right">1.102</td>
<td class="org-right">1.100</td>
<td class="org-right">0.046</td>
<td class="org-right">0.045</td>
<td class="org-right">1.030</td>
<td class="org-right">1.180</td>
<td class="org-right">1.001</td>
<td class="org-right">4008.337</td>
<td class="org-right">3167.030</td>
</tr>

<tr>
<td class="org-left">EC50Hat</td>
<td class="org-right">99.512</td>
<td class="org-right">99.542</td>
<td class="org-right">2.124</td>
<td class="org-right">2.098</td>
<td class="org-right">95.981</td>
<td class="org-right">102.987</td>
<td class="org-right">1.000</td>
<td class="org-right">2557.436</td>
<td class="org-right">2773.519</td>
</tr>

<tr>
<td class="org-left">omega[1]</td>
<td class="org-right">0.268</td>
<td class="org-right">0.267</td>
<td class="org-right">0.016</td>
<td class="org-right">0.016</td>
<td class="org-right">0.242</td>
<td class="org-right">0.295</td>
<td class="org-right">1.008</td>
<td class="org-right">594.842</td>
<td class="org-right">978.297</td>
</tr>

<tr>
<td class="org-left">omega[2]</td>
<td class="org-right">0.229</td>
<td class="org-right">0.228</td>
<td class="org-right">0.021</td>
<td class="org-right">0.021</td>
<td class="org-right">0.195</td>
<td class="org-right">0.264</td>
<td class="org-right">1.002</td>
<td class="org-right">1245.453</td>
<td class="org-right">1966.911</td>
</tr>

<tr>
<td class="org-left">omega[3]</td>
<td class="org-right">0.212</td>
<td class="org-right">0.211</td>
<td class="org-right">0.029</td>
<td class="org-right">0.029</td>
<td class="org-right">0.165</td>
<td class="org-right">0.261</td>
<td class="org-right">1.005</td>
<td class="org-right">623.820</td>
<td class="org-right">1692.248</td>
</tr>

<tr>
<td class="org-left">omega[4]</td>
<td class="org-right">0.263</td>
<td class="org-right">0.262</td>
<td class="org-right">0.026</td>
<td class="org-right">0.026</td>
<td class="org-right">0.221</td>
<td class="org-right">0.306</td>
<td class="org-right">1.002</td>
<td class="org-right">1396.611</td>
<td class="org-right">2260.425</td>
</tr>

<tr>
<td class="org-left">omega[5]</td>
<td class="org-right">0.272</td>
<td class="org-right">0.271</td>
<td class="org-right">0.036</td>
<td class="org-right">0.035</td>
<td class="org-right">0.217</td>
<td class="org-right">0.335</td>
<td class="org-right">1.008</td>
<td class="org-right">293.132</td>
<td class="org-right">728.867</td>
</tr>

<tr>
<td class="org-left">rho[1,2]</td>
<td class="org-right">0.197</td>
<td class="org-right">0.200</td>
<td class="org-right">0.100</td>
<td class="org-right">0.101</td>
<td class="org-right">0.029</td>
<td class="org-right">0.360</td>
<td class="org-right">1.003</td>
<td class="org-right">1322.261</td>
<td class="org-right">1955.862</td>
</tr>

<tr>
<td class="org-left">rho[1,3]</td>
<td class="org-right">-0.161</td>
<td class="org-right">-0.161</td>
<td class="org-right">0.122</td>
<td class="org-right">0.121</td>
<td class="org-right">-0.361</td>
<td class="org-right">0.042</td>
<td class="org-right">1.001</td>
<td class="org-right">1609.160</td>
<td class="org-right">2270.515</td>
</tr>

<tr>
<td class="org-left">rho[1,4]</td>
<td class="org-right">-0.101</td>
<td class="org-right">-0.105</td>
<td class="org-right">0.107</td>
<td class="org-right">0.107</td>
<td class="org-right">-0.270</td>
<td class="org-right">0.083</td>
<td class="org-right">1.001</td>
<td class="org-right">1685.591</td>
<td class="org-right">2353.498</td>
</tr>

<tr>
<td class="org-left">rho[1,5]</td>
<td class="org-right">0.016</td>
<td class="org-right">0.015</td>
<td class="org-right">0.128</td>
<td class="org-right">0.128</td>
<td class="org-right">-0.192</td>
<td class="org-right">0.226</td>
<td class="org-right">1.000</td>
<td class="org-right">2039.767</td>
<td class="org-right">2939.988</td>
</tr>

<tr>
<td class="org-left">rho[2,3]</td>
<td class="org-right">0.091</td>
<td class="org-right">0.092</td>
<td class="org-right">0.144</td>
<td class="org-right">0.148</td>
<td class="org-right">-0.143</td>
<td class="org-right">0.328</td>
<td class="org-right">1.008</td>
<td class="org-right">718.187</td>
<td class="org-right">1550.836</td>
</tr>

<tr>
<td class="org-left">rho[2,4]</td>
<td class="org-right">0.186</td>
<td class="org-right">0.190</td>
<td class="org-right">0.125</td>
<td class="org-right">0.125</td>
<td class="org-right">-0.025</td>
<td class="org-right">0.384</td>
<td class="org-right">1.005</td>
<td class="org-right">948.704</td>
<td class="org-right">1819.199</td>
</tr>

<tr>
<td class="org-left">rho[2,5]</td>
<td class="org-right">0.146</td>
<td class="org-right">0.145</td>
<td class="org-right">0.157</td>
<td class="org-right">0.161</td>
<td class="org-right">-0.111</td>
<td class="org-right">0.402</td>
<td class="org-right">1.003</td>
<td class="org-right">626.620</td>
<td class="org-right">1546.157</td>
</tr>

<tr>
<td class="org-left">rho[3,4]</td>
<td class="org-right">0.815</td>
<td class="org-right">0.827</td>
<td class="org-right">0.093</td>
<td class="org-right">0.094</td>
<td class="org-right">0.646</td>
<td class="org-right">0.947</td>
<td class="org-right">1.010</td>
<td class="org-right">309.098</td>
<td class="org-right">736.635</td>
</tr>

<tr>
<td class="org-left">rho[3,5]</td>
<td class="org-right">-0.318</td>
<td class="org-right">-0.323</td>
<td class="org-right">0.219</td>
<td class="org-right">0.228</td>
<td class="org-right">-0.678</td>
<td class="org-right">0.055</td>
<td class="org-right">1.016</td>
<td class="org-right">200.806</td>
<td class="org-right">607.958</td>
</tr>

<tr>
<td class="org-left">rho[4,5]</td>
<td class="org-right">-0.295</td>
<td class="org-right">-0.299</td>
<td class="org-right">0.161</td>
<td class="org-right">0.162</td>
<td class="org-right">-0.551</td>
<td class="org-right">-0.019</td>
<td class="org-right">1.008</td>
<td class="org-right">546.998</td>
<td class="org-right">1151.092</td>
</tr>

<tr>
<td class="org-left">omegaKe0</td>
<td class="org-right">0.265</td>
<td class="org-right">0.265</td>
<td class="org-right">0.047</td>
<td class="org-right">0.047</td>
<td class="org-right">0.188</td>
<td class="org-right">0.346</td>
<td class="org-right">1.001</td>
<td class="org-right">1731.276</td>
<td class="org-right">2049.892</td>
</tr>

<tr>
<td class="org-left">omegaEC50</td>
<td class="org-right">0.216</td>
<td class="org-right">0.216</td>
<td class="org-right">0.020</td>
<td class="org-right">0.020</td>
<td class="org-right">0.182</td>
<td class="org-right">0.249</td>
<td class="org-right">1.001</td>
<td class="org-right">1599.567</td>
<td class="org-right">1844.056</td>
</tr>

<tr>
<td class="org-left">sigma</td>
<td class="org-right">0.099</td>
<td class="org-right">0.099</td>
<td class="org-right">0.002</td>
<td class="org-right">0.002</td>
<td class="org-right">0.095</td>
<td class="org-right">0.103</td>
<td class="org-right">1.002</td>
<td class="org-right">1726.283</td>
<td class="org-right">2836.027</td>
</tr>

<tr>
<td class="org-left">sigmaResp</td>
<td class="org-right">10.165</td>
<td class="org-right">10.166</td>
<td class="org-right">0.198</td>
<td class="org-right">0.198</td>
<td class="org-right">9.844</td>
<td class="org-right">10.495</td>
<td class="org-right">1.002</td>
<td class="org-right">4788.527</td>
<td class="org-right">2923.203</td>
</tr>
</tbody>
</table>

<p>
<a href="../example-models/effCpt/density.pdf">../example-models/effCpt/density.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_5mg.pdf">../example-models/effCpt/ppc_study_1_5mg.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_10mg.pdf">../example-models/effCpt/ppc_study_1_10mg.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_20mg.pdf">../example-models/effCpt/ppc_study_1_20mg.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_40mg.pdf">../example-models/effCpt/ppc_study_1_40mg.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_2_20mg.pdf">../example-models/effCpt/ppc_study_2_20mg.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_5mg_resp.pdf">../example-models/effCpt/ppc_study_1_5mg_resp.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_10mg_resp.pdf">../example-models/effCpt/ppc_study_1_10mg_resp.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_20mg_resp.pdf">../example-models/effCpt/ppc_study_1_20mg_resp.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_1_40mg_resp.pdf">../example-models/effCpt/ppc_study_1_40mg_resp.pdf</a>
</p>

<p>
<a href="../example-models/effCpt/ppc_study_2_20mg_resp.pdf">../example-models/effCpt/ppc_study_2_20mg_resp.pdf</a>
</p>
</div>
</div>
</div>


<div id="outline-container-orgfd06df0" class="outline-3">
<h3 id="orgfd06df0"><span class="section-number-3">4.10</span> Friberg-Karlsson Semi-Mechanistic Population Model</h3>
<div class="outline-text-3" id="text-4-10">
<p>
\label{sec:fkpop_model}
We now return to the example in Section <a href="#sec:fk_model">sec:fk_model</a> and extend
it to a population model. While we recommend using the coupled
solver, and this time we solve it using group solver. We leave it
as an exercise to the reader to rewrite the model with
coupled solver.
</p>
</div>

<div id="outline-container-orgd18220a" class="outline-4">
<h4 id="orgd18220a"><span class="section-number-4">4.10.1</span> Friberg-Karlsson Population Model for drug-induced myelosuppression (\(ANC\))</h4>
<div class="outline-text-4" id="text-4-10-1">
\begin{gather*}
\log(ANC_{ij}) \sim N(Circ_{ij}, \sigma^2_{ANC}), \\
\log\left(MTT_j, Circ_{0j}, \alpha_j\right) \sim N\left(\log\left(\widehat{MTT}, \widehat{Circ_0}, \widehat{\alpha}\right), \Omega_{ANC}\right), \\
\left(\widehat{MTT}, \widehat{Circ}_0,\widehat{\alpha}, \gamma \right) = \left(125, 5, 2, 0.17\right), \\
\Omega_{ANC} = \left(\begin{array}{ccc} 0.2^2 & 0 & 0 \\ 0 & 0.35^2 & 0 \\ 0 & 0 & 0.2^2 \end{array}\right), \\
\sigma_{ANC} = 0.1, \\
\Omega_{PK} = \left(\begin{array}{ccccc} 0.25^2 & 0 &a 0 & 0 & 0 \\ 0 & 0.4^2 & 0 & 0 & 0 \\
0 & 0 & 0.25^2 & 0 & 0 \\ 0 & 0 & 0 & 0.4^2 & 0 \\ 0 & 0 & 0 & 0 & 0.25^2  \end{array}\right)
\end{gather*}
<p>
The PK and the PD data are simulated using the following treatment.
</p>
<ul class="org-ul">
<li>Phase IIa trial in patients
<ul class="org-ul">
<li>Multiple doses: 80,000 mg</li>
<li>Parallel dose escalation design</li>
<li>15 subjects</li>
<li>PK: plasma concentration of parent drug (\(c\))</li>
<li>PD response: Neutrophil count (\(ANC\))</li>
<li>PK measured at 0.083, 0.167, 0.25, 0.5, 0.75, 1, 2, 3, 4, 6, 8, 12, 18, and 24 hours</li>
<li>PD measured once every two days for 28 days.</li>
</ul></li>
</ul>

<p>
Once again, we simultaneously fit the model to the PK and the PD
data. It pays off to construct informative priors. For instance, we could
fit the PK data first, as was done in  example 1, and get informative
priors on the PK parameters. The PD parameters are drug independent,
so we can use information from the neutropenia literature. In this
example, we choose to use strongly informative priors on both PK and PD
parameters.
</p>

<p>
The ODE is defined as 
</p>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">functions</span>{
    <span style="color: #b58900;">vector</span> <span style="color: #268bd2;">twoCptNeutModelODE</span>(<span style="color: #b58900;">real</span> t, <span style="color: #b58900;">vector</span> x, <span style="color: #b58900;">real</span>[] parms, <span style="color: #b58900;">real</span>[] rdummy, <span style="color: #b58900;">int</span>[] idummy){
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">k10</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">k12</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">k21</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">CL</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">Q</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">V1</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">V2</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ka</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">mtt</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">circ0</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">gamma</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">alpha</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">ktr</span>;
    <span style="color: #b58900;">vector</span>[8] <span style="color: #268bd2;">dxdt</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">conc</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">EDrug</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">transit1</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">transit2</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">transit3</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">circ</span>;
    <span style="color: #b58900;">real</span> <span style="color: #268bd2;">prol</span>;

    CL <span style="color: #268bd2; font-weight: bold;">=</span> parms[1];
    Q <span style="color: #268bd2; font-weight: bold;">=</span> parms[2];
    V1 <span style="color: #268bd2; font-weight: bold;">=</span> parms[3];
    V2 <span style="color: #268bd2; font-weight: bold;">=</span> parms[4];
    ka <span style="color: #268bd2; font-weight: bold;">=</span> parms[5];
    mtt <span style="color: #268bd2; font-weight: bold;">=</span> parms[6];     
    circ0 <span style="color: #268bd2; font-weight: bold;">=</span> parms[7];
    gamma <span style="color: #268bd2; font-weight: bold;">=</span> parms[8];
    alpha <span style="color: #268bd2; font-weight: bold;">=</span> parms[9];

    k10 <span style="color: #268bd2; font-weight: bold;">=</span> CL / V1;
    k12 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V1;
    k21 <span style="color: #268bd2; font-weight: bold;">=</span> Q / V2;

    ktr <span style="color: #268bd2; font-weight: bold;">=</span> 4 / mtt;

    dxdt[1] <span style="color: #268bd2; font-weight: bold;">=</span> -ka * x[1];
    dxdt[2] <span style="color: #268bd2; font-weight: bold;">=</span> ka * x[1] - (k10 + k12) * x[2] + k21 * x[3];
    dxdt[3] <span style="color: #268bd2; font-weight: bold;">=</span> k12 * x[2] - k21 * x[3];
    conc <span style="color: #268bd2; font-weight: bold;">=</span> x[2]/V1;
    EDrug <span style="color: #268bd2; font-weight: bold;">=</span> alpha * conc;
    <span style="color: #586e75;">// </span><span style="color: #586e75;">x[4], x[5], x[6], x[7] and x[8] are differences from circ0.</span>
    prol <span style="color: #268bd2; font-weight: bold;">=</span> x[4] + circ0;
    transit1 <span style="color: #268bd2; font-weight: bold;">=</span> x[5] + circ0;
    transit2 <span style="color: #268bd2; font-weight: bold;">=</span> x[6] + circ0;
    transit3 <span style="color: #268bd2; font-weight: bold;">=</span> x[7] + circ0;
    circ <span style="color: #268bd2; font-weight: bold;">=</span> <span style="color: #268bd2;">fmax</span>(machine_precision(), x[8] + circ0); <span style="color: #586e75;">// </span><span style="color: #586e75;">Device for implementing a modeled </span>
                                                    <span style="color: #586e75;">// </span><span style="color: #586e75;">initial condition</span>
    dxdt[4] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * prol * ((1 - EDrug) * ((circ0 / circ)^gamma) - 1);
    dxdt[5] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (prol - transit1);
    dxdt[6] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit1 - transit2);
    dxdt[7] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit2 - transit3);
    dxdt[8] <span style="color: #268bd2; font-weight: bold;">=</span> ktr * (transit3 - circ);

    <span style="color: #859900; font-weight: bold;">return</span> dxdt;
  }
}
</pre>
</div>

<p>
We use the <code>pmx_solve_group_rk45</code> function to
solve the entire population's events. 
</p>
<div class="org-src-container">
<pre class="src src-stan"><span style="color: #859900; font-weight: bold;">transformed parameters</span>{
  <span style="color: #b58900;">row_vector</span>[nt] <span style="color: #268bd2;">cHat</span>;
  <span style="color: #b58900;">vector</span>[nObsPK] <span style="color: #268bd2;">cHatObs</span>;
  <span style="color: #b58900;">row_vector</span>[nt] <span style="color: #268bd2;">neutHat</span>;
  <span style="color: #b58900;">vector</span>[nObsPD] <span style="color: #268bd2;">neutHatObs</span>;
  <span style="color: #b58900;">matrix</span>[8, nt] <span style="color: #268bd2;">x</span>;
  <span style="color: #b58900;">real</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt; <span style="color: #268bd2;">parms</span>[nSubjects, nTheta]; <span style="color: #586e75;">// </span><span style="color: #586e75;">The [1] indicates the parameters are constant</span>

  <span style="color: #586e75;">// </span><span style="color: #586e75;">variables for Matt's trick</span>
  <span style="color: #b58900;">vector</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nIIV] <span style="color: #268bd2;">thetaHat</span>;
  <span style="color: #b58900;">matrix</span>&lt;<span style="color: #859900; font-weight: bold;">lower</span> <span style="color: #268bd2; font-weight: bold;">=</span> 0&gt;[nSubjects, nIIV] <span style="color: #268bd2;">thetaM</span>; 

  <span style="color: #586e75;">// </span><span style="color: #586e75;">Matt's trick to use unit scale</span>
  thetaHat[1] <span style="color: #268bd2; font-weight: bold;">=</span> CLHat; 
  thetaHat[2] <span style="color: #268bd2; font-weight: bold;">=</span> QHat;
  thetaHat[3] <span style="color: #268bd2; font-weight: bold;">=</span> V1Hat;
  thetaHat[4] <span style="color: #268bd2; font-weight: bold;">=</span> V2Hat;
  thetaHat[5] <span style="color: #268bd2; font-weight: bold;">=</span> mttHat;
  thetaHat[6] <span style="color: #268bd2; font-weight: bold;">=</span> circ0Hat;
  thetaHat[7] <span style="color: #268bd2; font-weight: bold;">=</span> alphaHat;
  thetaM <span style="color: #268bd2; font-weight: bold;">=</span> (<span style="color: #268bd2;">rep_matrix</span>(thetaHat, nSubjects) .* 
             <span style="color: #268bd2;">exp</span>(<span style="color: #268bd2;">diag_pre_multiply</span>(omega, L * etaStd)))';

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nSubjects) {
    parms[i, 1] <span style="color: #268bd2; font-weight: bold;">=</span> thetaM[i, 1] * (weight[i] / 70)^0.75; <span style="color: #586e75;">// </span><span style="color: #586e75;">CL</span>
    parms[i, 2] <span style="color: #268bd2; font-weight: bold;">=</span> thetaM[i, 2] * (weight[i] / 70)^0.75; <span style="color: #586e75;">// </span><span style="color: #586e75;">Q</span>
    parms[i, 3] <span style="color: #268bd2; font-weight: bold;">=</span> thetaM[i, 3] * (weight[i] / 70); <span style="color: #586e75;">// </span><span style="color: #586e75;">V1</span>
    parms[i, 4] <span style="color: #268bd2; font-weight: bold;">=</span> thetaM[i, 4] * (weight[i] / 70); <span style="color: #586e75;">// </span><span style="color: #586e75;">V2</span>
    parms[i, 5] <span style="color: #268bd2; font-weight: bold;">=</span> kaHat; <span style="color: #586e75;">// </span><span style="color: #586e75;">ka</span>
    parms[i, 6] <span style="color: #268bd2; font-weight: bold;">=</span> thetaM[i, 5]; <span style="color: #586e75;">// </span><span style="color: #586e75;">mtt</span>
    parms[i, 7] <span style="color: #268bd2; font-weight: bold;">=</span> thetaM[i, 6]; <span style="color: #586e75;">// </span><span style="color: #586e75;">circ0</span>
    parms[i, 8] <span style="color: #268bd2; font-weight: bold;">=</span> gamma;
    parms[i, 9] <span style="color: #268bd2; font-weight: bold;">=</span> thetaM[i, 7]; <span style="color: #586e75;">// </span><span style="color: #586e75;">alpha</span>
  }

  <span style="color: #586e75;">/* </span><span style="color: #586e75;">group solver</span><span style="color: #586e75;"> */</span>
  x <span style="color: #268bd2; font-weight: bold;">=</span> pmx_solve_group_rk45(twoCptNeutModelODE, 8, len,
                           time, amt, rate, ii, evid, cmt, addl, ss,
                           parms, 
                           1e-6, 1e-6, 500);

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nSubjects) {
    cHat[start[i]:end[i]] <span style="color: #268bd2; font-weight: bold;">=</span> x[2, start[i]:end[i]] / parms[i, 3]; <span style="color: #586e75;">// </span><span style="color: #586e75;">divide by V1</span>
    neutHat[start[i]:end[i]] <span style="color: #268bd2; font-weight: bold;">=</span> x[8, start[i]:end[i]] + parms[i, 7]; <span style="color: #586e75;">// </span><span style="color: #586e75;">Add baseline</span>
  }

  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObsPK) cHatObs[i] <span style="color: #268bd2; font-weight: bold;">=</span> cHat[iObsPK[i]];
  <span style="color: #859900; font-weight: bold;">for</span>(i <span style="color: #859900; font-weight: bold;">in</span> 1:nObsPD) neutHatObs[i] <span style="color: #268bd2; font-weight: bold;">=</span> neutHat[iObsPD[i]];
}
</pre>
</div>

<p>
This allows us to use within-chain paralleleisation to reduce
simulation time. When run from cmdstan, each MPI run generates one
chain, and we use 4 MPI runs to generate 4 chains.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #586e75;"># </span><span style="color: #586e75;">chain 1</span>
mpiexec -n nproc ./FribergKarlsson sample adapt <span style="color: #268bd2;">delta</span>=0.95 data <span style="color: #268bd2;">file</span>=fribergkarlsson.data.R <span style="color: #268bd2;">init</span>=fribergkarlsson.init.R random <span style="color: #268bd2;">seed</span>=8765 <span style="color: #268bd2;">id</span>=1 output <span style="color: #268bd2;">file</span>=output.1.csv
<span style="color: #586e75;"># </span><span style="color: #586e75;">chain 2</span>
mpiexec -n nproc ./FribergKarlsson sample adapt <span style="color: #268bd2;">delta</span>=0.95 data <span style="color: #268bd2;">file</span>=fribergkarlsson.data.R <span style="color: #268bd2;">init</span>=fribergkarlsson.init.R random <span style="color: #268bd2;">seed</span>=8765 <span style="color: #268bd2;">id</span>=2 output <span style="color: #268bd2;">file</span>=output.2.csv
<span style="color: #586e75;"># </span><span style="color: #586e75;">chain 3</span>
mpiexec -n nproc ./FribergKarlsson sample adapt <span style="color: #268bd2;">delta</span>=0.95 data <span style="color: #268bd2;">file</span>=fribergkarlsson.data.R <span style="color: #268bd2;">init</span>=fribergkarlsson.init.R random <span style="color: #268bd2;">seed</span>=8765 <span style="color: #268bd2;">id</span>=3 output <span style="color: #268bd2;">file</span>=output.3.csv
<span style="color: #586e75;"># </span><span style="color: #586e75;">chain 4</span>
mpiexec -n nproc ./FribergKarlsson sample adapt <span style="color: #268bd2;">delta</span>=0.95 data <span style="color: #268bd2;">file</span>=fribergkarlsson.data.R <span style="color: #268bd2;">init</span>=fribergkarlsson.init.R random <span style="color: #268bd2;">seed</span>=8765 <span style="color: #268bd2;">id</span>=4 output <span style="color: #268bd2;">file</span>=output.4.csv
</pre>
</div>
</div>
</div>

<div id="outline-container-org70a070d" class="outline-4">
<h4 id="org70a070d"><span class="section-number-4">4.10.2</span> Results</h4>
<div class="outline-text-4" id="text-4-10-2">
<p>
Table <a href="#FkpopModelParms">FkpopModelParms</a> summarizes the sampling and some diagnostics output.
estimation reflects the real value of the parameters (Table <a href="#FkpopModelParms">FkpopModelParms</a> and Figure <a href="#fkpop_mcmc_density">fkpop_mcmc_density</a>.
Similar to the previous example, PPCs shown in Figure <a href="#fkpop_ppc_pk">fkpop_ppc_pk</a>
and <a href="#fkpop_ppc_pd">fkpop_ppc_pd</a> indicate the model is a good fit.
</p>

<table id="orga6c4739" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Summary of the MCMC simulations of the marginal posterior distributions of the model parameters for the Friberg-Karlsson population model example.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">variable</th>
<th scope="col" class="org-right">mean</th>
<th scope="col" class="org-right">median</th>
<th scope="col" class="org-right">sd</th>
<th scope="col" class="org-right">mad</th>
<th scope="col" class="org-right">q5</th>
<th scope="col" class="org-right">q95</th>
<th scope="col" class="org-right">rhat</th>
<th scope="col" class="org-right">ess<sub>bulk</sub></th>
<th scope="col" class="org-right">ess<sub>tail</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CLHat</td>
<td class="org-right">9.539</td>
<td class="org-right">9.535</td>
<td class="org-right">0.522</td>
<td class="org-right">0.487</td>
<td class="org-right">8.692</td>
<td class="org-right">10.401</td>
<td class="org-right">1.006</td>
<td class="org-right">971.369</td>
<td class="org-right">1655.449</td>
</tr>

<tr>
<td class="org-left">QHat</td>
<td class="org-right">15.401</td>
<td class="org-right">15.386</td>
<td class="org-right">1.018</td>
<td class="org-right">1.000</td>
<td class="org-right">13.742</td>
<td class="org-right">17.090</td>
<td class="org-right">1.000</td>
<td class="org-right">2263.843</td>
<td class="org-right">2447.006</td>
</tr>

<tr>
<td class="org-left">V1Hat</td>
<td class="org-right">37.396</td>
<td class="org-right">37.360</td>
<td class="org-right">2.244</td>
<td class="org-right">2.228</td>
<td class="org-right">33.762</td>
<td class="org-right">41.058</td>
<td class="org-right">1.001</td>
<td class="org-right">1936.476</td>
<td class="org-right">2372.815</td>
</tr>

<tr>
<td class="org-left">V2Hat</td>
<td class="org-right">101.698</td>
<td class="org-right">101.394</td>
<td class="org-right">6.503</td>
<td class="org-right">6.119</td>
<td class="org-right">91.529</td>
<td class="org-right">112.538</td>
<td class="org-right">1.001</td>
<td class="org-right">2580.227</td>
<td class="org-right">2592.925</td>
</tr>

<tr>
<td class="org-left">kaHat</td>
<td class="org-right">1.997</td>
<td class="org-right">1.997</td>
<td class="org-right">0.074</td>
<td class="org-right">0.074</td>
<td class="org-right">1.873</td>
<td class="org-right">2.115</td>
<td class="org-right">1.001</td>
<td class="org-right">7056.877</td>
<td class="org-right">2993.406</td>
</tr>

<tr>
<td class="org-left">mttHat</td>
<td class="org-right">113.681</td>
<td class="org-right">113.204</td>
<td class="org-right">11.506</td>
<td class="org-right">10.910</td>
<td class="org-right">95.807</td>
<td class="org-right">133.514</td>
<td class="org-right">1.001</td>
<td class="org-right">4255.900</td>
<td class="org-right">3269.646</td>
</tr>

<tr>
<td class="org-left">circ0Hat</td>
<td class="org-right">4.760</td>
<td class="org-right">4.752</td>
<td class="org-right">0.241</td>
<td class="org-right">0.229</td>
<td class="org-right">4.375</td>
<td class="org-right">5.163</td>
<td class="org-right">1.002</td>
<td class="org-right">3774.920</td>
<td class="org-right">2783.663</td>
</tr>

<tr>
<td class="org-left">omega[1]</td>
<td class="org-right">0.223</td>
<td class="org-right">0.217</td>
<td class="org-right">0.047</td>
<td class="org-right">0.042</td>
<td class="org-right">0.160</td>
<td class="org-right">0.307</td>
<td class="org-right">1.000</td>
<td class="org-right">1751.864</td>
<td class="org-right">2235.607</td>
</tr>

<tr>
<td class="org-left">omega[2]</td>
<td class="org-right">0.339</td>
<td class="org-right">0.329</td>
<td class="org-right">0.073</td>
<td class="org-right">0.067</td>
<td class="org-right">0.239</td>
<td class="org-right">0.473</td>
<td class="org-right">1.001</td>
<td class="org-right">2363.843</td>
<td class="org-right">2607.056</td>
</tr>

<tr>
<td class="org-left">omega[3]</td>
<td class="org-right">0.264</td>
<td class="org-right">0.256</td>
<td class="org-right">0.057</td>
<td class="org-right">0.051</td>
<td class="org-right">0.186</td>
<td class="org-right">0.367</td>
<td class="org-right">1.002</td>
<td class="org-right">2128.660</td>
<td class="org-right">2018.425</td>
</tr>

<tr>
<td class="org-left">omega[4]</td>
<td class="org-right">0.257</td>
<td class="org-right">0.249</td>
<td class="org-right">0.056</td>
<td class="org-right">0.051</td>
<td class="org-right">0.182</td>
<td class="org-right">0.361</td>
<td class="org-right">1.003</td>
<td class="org-right">2293.877</td>
<td class="org-right">2937.673</td>
</tr>

<tr>
<td class="org-left">omega[5]</td>
<td class="org-right">0.177</td>
<td class="org-right">0.169</td>
<td class="org-right">0.112</td>
<td class="org-right">0.118</td>
<td class="org-right">0.019</td>
<td class="org-right">0.376</td>
<td class="org-right">1.000</td>
<td class="org-right">1550.483</td>
<td class="org-right">2045.025</td>
</tr>

<tr>
<td class="org-left">omega[6]</td>
<td class="org-right">0.188</td>
<td class="org-right">0.183</td>
<td class="org-right">0.044</td>
<td class="org-right">0.041</td>
<td class="org-right">0.127</td>
<td class="org-right">0.269</td>
<td class="org-right">1.000</td>
<td class="org-right">2377.698</td>
<td class="org-right">2965.713</td>
</tr>

<tr>
<td class="org-left">omega[7]</td>
<td class="org-right">0.409</td>
<td class="org-right">0.394</td>
<td class="org-right">0.256</td>
<td class="org-right">0.259</td>
<td class="org-right">0.045</td>
<td class="org-right">0.865</td>
<td class="org-right">1.003</td>
<td class="org-right">1386.987</td>
<td class="org-right">2015.873</td>
</tr>

<tr>
<td class="org-left">gamma</td>
<td class="org-right">0.171</td>
<td class="org-right">0.168</td>
<td class="org-right">0.035</td>
<td class="org-right">0.033</td>
<td class="org-right">0.121</td>
<td class="org-right">0.235</td>
<td class="org-right">1.000</td>
<td class="org-right">8809.668</td>
<td class="org-right">3189.676</td>
</tr>

<tr>
<td class="org-left">sigma</td>
<td class="org-right">0.097</td>
<td class="org-right">0.096</td>
<td class="org-right">0.003</td>
<td class="org-right">0.003</td>
<td class="org-right">0.093</td>
<td class="org-right">0.101</td>
<td class="org-right">1.002</td>
<td class="org-right">5436.508</td>
<td class="org-right">2899.706</td>
</tr>

<tr>
<td class="org-left">sigmaNeut</td>
<td class="org-right">0.106</td>
<td class="org-right">0.105</td>
<td class="org-right">0.012</td>
<td class="org-right">0.011</td>
<td class="org-right">0.088</td>
<td class="org-right">0.127</td>
<td class="org-right">1.000</td>
<td class="org-right">2809.059</td>
<td class="org-right">3031.605</td>
</tr>

<tr>
<td class="org-left">alphaHat</td>
<td class="org-right">2.24e-4</td>
<td class="org-right">2.19e-4</td>
<td class="org-right">3.97e-05</td>
<td class="org-right">3.80e-05</td>
<td class="org-right">1.66e-4</td>
<td class="org-right">2.96e-4</td>
<td class="org-right">1.000</td>
<td class="org-right">5138.105</td>
<td class="org-right">2807.328</td>
</tr>
</tbody>
</table>

<p>
<a href="../example-models/FribergKarlsson/density.pdf">../example-models/FribergKarlsson/density.pdf</a>
</p>

<p>
<a href="../example-models/FribergKarlsson/ppc_pk.pdf">../example-models/FribergKarlsson/ppc_pk.pdf</a>
</p>

<p>
<a href="../example-models/FribergKarlsson/ppc_pd.pdf">../example-models/FribergKarlsson/ppc_pd.pdf</a>
</p>

<p>
\appendix
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd7f7fe7" class="outline-2">
<h2 id="orgd7f7fe7">Compiling constants</h2>
<div class="outline-text-2" id="text-orgd7f7fe7">
<p>
Several constants are used in Torsten's makefile. These constants can
be used in <code>cmdstan/make/local</code> file, or use <code>set_make_local</code> command
in <code>cmdstanr</code>.
</p>
<ul class="org-ul">
<li><code>TORSTEN_MPI=1</code> turns on within-chain parallelsation of MPI-enable
functions. To use this option one must also point
<code>TBB\_CXX\_TYPE</code> to proper C compiler. See also section <a href="#sec:ode_group_note">sec:ode_group_note</a> and <a href="#sec:ode_integ_group_note">sec:ode_integ_group_note</a>.</li>
<li><code>TORSTEN_CVS_JAC_AD=1</code> makes BDF and Adams
integrator use Stan's automatic differentiation to calculate
Jacobian matrix in nonlinear solver (<a href="#citeproc_bib_item_6">Hindmarsh et al. 2020</a>).</li>
</ul>

<p>
\printindex
</p>

<p>
\backmatter
</p>

<p>
<a id="org7103ac2"></a>

</p>

<p>
<a id="org2152f67"></a>
</p>

<style>.csl-entry{text-indent: -1.5em; margin-left: 1.5em;}</style><h2 class='citeproc-org-bib-h2'>Bibliography</h2>
<div class="csl-bib-body">
  <div class="csl-entry"><a name="citeproc_bib_item_1"></a>Baron, Kyle T., and Marc R. Gastonguay. 2015. “Simulation from ODE-Based Population PK/PD and Systems Pharmacology Models in R with Mrgsolve.” <i>Journal of Pharmacokinetics and Pharmacodynamics</i> 42 (W-23):S84–85.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_2"></a>Betancourt, Michael. 2018. “A Conceptual Introduction to Hamiltonian Monte Carlo.” <a href="https://arxiv.org/abs/1701.02434">https://arxiv.org/abs/1701.02434</a>.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_3"></a>Carpenter, Bob, Andrew Gelman, Matthew D. Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. “Stan: A Probabilistic Programming Language.” <i>Journal of Statistical Software</i> 76.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_4"></a>Carpenter, Bob, Matthew D. Hoffman, Marcus Brubaker, Daniel Lee, Peter Li, and Michael Betancourt. 2015. “The Stan Math Library: Reverse-Mode Automatic Differentiation in C++.” <i>arXiv:1509.07164 [Cs]</i>, September. <a href="http://arxiv.org/abs/1509.07164">http://arxiv.org/abs/1509.07164</a>.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_5"></a>Friberg, Lena E., and Mats O. Karlsson. 2003. “Mechanistic Models for Myelosuppression.” <i>Investigational New Drugs</i> 21 (2):183–94. <a href="https://link.springer.com/article/10.1023/A:1023573429626">https://link.springer.com/article/10.1023/A:1023573429626</a>.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_6"></a>Hindmarsh, Alan C., Radu Serban, Cody J. Balos, David J. Gardner, Carol S. Woodward, and Daniel R. Reynolds. 2020. <i>User Documentation for Cvodes V5.4.0</i>.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_7"></a>Hoffman, Matthew D., and Andrew Gelman. 2011. “The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo.” <i>arXiv:1111.4246 [Cs, Stat]</i>, November. <a href="http://arxiv.org/abs/1111.4246">http://arxiv.org/abs/1111.4246</a>.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_8"></a>Shampine, L. F., I. Gladwell, Larry Shampine, and S. Thompson. 2003. <i>Solving ODEs with MATLAB</i>. Cambridge University Press.</div>
  <div class="csl-entry"><a name="citeproc_bib_item_9"></a>Team, Stan Development. 2020. <i>CmdStan User’s Guide</i>. <a href="https://mc-stan.org/docs/2_26/cmdstan-guide/index.html">https://mc-stan.org/docs/2_26/cmdstan-guide/index.html</a>.</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">NONMEM\textregistered{} is licensed and distributed by ICON Development Solutions.</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Yi Zhang</p>
<p class="date">Created: 2021-06-28 Mon 13:34</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
