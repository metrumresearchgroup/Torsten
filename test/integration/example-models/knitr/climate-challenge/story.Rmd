---
title: "Climate challenge (for the Bayes in Stan book)"
author: "Andrew Gelman"
date: "15 Jul 2018"
output:
  html_document:
    theme: readable
---

```{r setup, include=FALSE, echo=FALSE}
options(htmltools.dir.version = FALSE)
options(digits = 2)

library(knitr)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'))
knitr::opts_chunk$set(comment = "")

print_file <- function(file) {
  cat(paste(readLines(file), "\n", sep=""), sep="")
}

library("arm")
library("rstan")
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```
A few years ago someone sent me an email about a "Global Climate Challenge" that he had seen online, and which was introduced as follows:

> It has often been claimed that alarm about global warming is supported by observational evidence. I have argued that there is no observational evidence for global-warming alarm: rather, all claims of such evidence rely on invalid statistical analyses.

> Some people, though, have asserted that the statistical analyses are valid. Those people assert, in particular, that they can determine, via statistical analysis, whether global temperatures have been increasing more than would be reasonably expected by random natural variation. Those people do not present any counter to my argument, but they make their assertions anyway.

> In response to that, I am sponsoring a contest: the prize is $100 000. In essence, the prize will be awarded to anyone who can demonstrate, via statistical analysis, that the increase in global temperatures is probably not due to random natural variation.

How to win the money?

> The file Series1000.txt contains 1000 time series. Each series has length 135: the same as that of the most commonly studied series of global temperatures (which span 1880–2014). The 1000 series were generated as follows. First, 1000 random series were obtained (via a trendless statistical model fit for global temperatures). Then, some randomly-selected series had a trend added to them. Some trends were positive; the others were negative. Each individual trend was 1°C/century (in magnitude)—which is greater than the trend claimed for global temperatures.

> A prize of $100 000 (one hundred thousand U.S. dollars) will be awarded to the first person who submits an entry that correctly identifies at least 900 series: which series were generated by a trendless process and which were generated by a trending process.

But also this:

> Each entry must be accompanied by a payment of $10.

OK, now it’s time to get to work.  We start by downloading and graphing the data.
```{r, echo=FALSE}
series <- matrix(scan("Series1000.txt"), nrow=1000, ncol=135, byrow=TRUE)
T <- 135
N <- 1000
par(mar=c(3,3,2,0), tck=-.01, mgp=c(1.5,.5,0))
plot(c(1,T), range(series), bty="l", type="n", xlab="Time", ylab="series")
for (n in 1:N){
  lines(1:T, series[n,], lwd=.5)
}
```

Aha! The lines are fanning out from a common starting point. We'll fit a regression to each line and then summarize each line by its average slope.

```{r, echo=FALSE}
slope <- rep(NA, N)
se <- rep(NA, N)
for (n in 1:N){
  data <- series[n,]
  time <- 1:T
  fit <- lm(data ~ time)
  slope[n] <- 100*coef(fit)[2]
  se[n] <- 100*se.coef(fit)[2]
}
```

We multiplied the slopes (and standard errors) by 100 to put them on a per-century scale to match the above instructions.

Next we plot the estimated slopes and their standard errors:

```{r, echo=FALSE}
plot(slope, se, bty="l", xlab="Slope", ylab="SE", pch=20)
```

OK, not much information in the se's. How about a histogram of the estimated slopes?

```{r, echo=FALSE}
hist(slope, xlab="Slope", breaks=seq(floor(10*min(slope)), ceiling(10*max(slope)))/10)
```

Based on the problem description, I'd expect to see distributions centered at 0, -1, and 1. It looks like this might be the case.

So let's fit a mixture model. That's easy.  Here's the Stan program:

```{r, echo=FALSE}
print_file("mixture.stan")
```

We now run the program and display the results:

```{r, echo=FALSE}
y <- slope
K <- 3
mu <- c(0,-1,1)
data <- list(y=y, K=K, mu=mu)
mix <- stan("mixture.stan", data=data)
print(mix)
```

Convergence is fine:  $\widehat{R}$ is close to 1 for everything.  The estimated weights of the three mixture components are approximately 0.5, 0.25, 0.25. Given that the problem was made up, I'm guessing the weights of the underlying data-generation process are exactly 1/2, 1/4, and 1/4. The standard deviation of the slopes within each component is 0.4, or close to it. We could also try fitting a model where the standard deviations of the three components differ, but we won't, partly because the description given with the simulated data described the change as adding a trend, and partly because the above histogram doesn't seem to show any varying of the widths of the mixture components.

OK, now we're getting somewhere. To make predictions, we need to know, for each series, the probability of it being in each of the three components. We'll compute these probabilities by adding a generated quantities block to the Stan program:

```
generated quantities {
  matrix[N,K] p;
  for (n in 1:N){
    vector[K] p_raw; 
    for (k in 1:K){
      p_raw[k] <- theta[k]*exp(normal_log(y[n], mu[k], sigma));
    }
    for (k in 1:K){
      p[n,k] <- p_raw[k]/sum(p_raw);
    }
  }
}
```

We then re-fit the model, extract the $p$'s, and average them over the posterior simulations.

```{r, echo=FALSE, results=FALSE}
mix <- stan("mixture_2.stan", data=data)
prob_sims <- extract(mix)$p
prob <- array(NA, c(N,K))
for (n in 1:N){
  for (k in 1:K){
    prob[n,k] <- mean(prob_sims[,n,k])
  }
}
```

We now have a $1000\times 3$ matrix of probabilities. Let's take a look at the first ten rows

```{r, echo=FALSE}
pfround(prob[1:10,], 2)
```

So, the first series is probably drawn from the sloping-upward model; the second might be from the null model or it might be from the sloping-downward model; the third, fourth, fifth, sixth, seventh, and eighth are probably from the null model; the ninth is probably from the sloping-upward model; and so forth.

We'll now program this: for each of the 1000 series in the dataset, we'll pick which of the three mixture components has the highest probability. We'll save the probability and also which component is being picked.

```{r, echo=FALSE}
max_prob <- apply(prob, 1, max)
choice <- apply(prob, 1, which.max)
```

And now we can sum this over the 1000 series. We'll compute the number of series assigned to each of the three choices:

```{r, echo=FALSE}
print(table(choice))
```

The guesses are not quite in proportion 500, 250, 250. There seem to be too many guesses of zero slope and not enough of positive and negative slopes. But that makes sense given the decision problem: we want to maximize the number of correct guesses so we end up disproportionately guessing the most common category. That's fine; it's how it will be.

And we can compute the expected number of correct guesses (based on the posterior distribution we have here), and the standard deviation of the number of correct guesses (based on the reasonable approximation of independence of the 1000 series conditional on the model). And then we'll print all these numbers:

```{r, echo=FALSE}
expected_correct <- sum(max_prob)
sd_correct <- sqrt(sum(max_prob*(1-max_prob)))
pfround(c(expected_correct, sd_correct), 1)
```

Interesting.  The expected number of correct guesses is 854.1. Not quite the 900 that's needed to win! The standard error of the number of correct guesses is 10.3, so 900 is over 5 standard errors away from our expected number correct. That's bad news!

How bad is it?  We can compute the normal cumulative density fucntion to get the probability of at least 900 successes; that's $\mbox{pnorm}(854.1, 900, 10.3)$:
```{r, echo=FALSE}
pnorm(expected_correct, 900, sd_correct)
```
That's a small number; here's its reciprocal:
```{r, echo=FALSE}
1/pnorm(expected_correct, 900, sd_correct)
```
That's a 1-in-230,000 chance of winning the big prize!

But we only have to get _at least_ 900. So we can do the continuity correction and evaluate the probability of at least 899.5 successes, which, when inverted, yields:
```{r, echo=FALSE}
1/pnorm(expected_correct, 899.5, sd_correct)
```
Nope, still no good. For the bet to be worth it, even in the crudest sense of expected monetary value, the probability of winning would have to be at least 1 in 10,000. (Recall that the prize is \$100,000 but the cost of entry is \$10.) And that's all conditional on the designer of the study doing everything exactly as he said, and not playing with multiple seeds for the random number generator, etc. After all, he could well have first chosen a seed and generated the series, then performed something like the above analysis and checked that the most natural estimate gave only 850 correct or so, and in the very unlikely event that the natural estimate gave 900 or close to it, just re-running with a new seed. I have no reason to think that the creator of this challenge did anything like that; my point here is only that, even if he did his simulation in a completely clean way, our odds of winning are about 1 in 200,000---about 1/20th what we'd need for this to be a fair game.

There is one more thing, though: the data are highly autocorrelated, so least-squares regression may not be the most efficient way to estimate these slopes. If we can estimate the slopes more precisely, we can get more discrimination in our predictions.  Maybe there is a way to win the game by extracting more information from each series, but it won't be easy.

You could say that the above all demonstrates the designer's point, that you can't identify a trend in a time series of this length. But I don't think it would make sense to draw that conclusion from this exercise. After all, you can just tweak the parameters in the problem a bit---or simply set the goal to 800 correct instead of 900---and the game becomes easy to win. Or, had the game been winnable as initially set up, you could just up the threshold to 950, and again it would become essentially impossible to win. Conversely, if the designer of the challenge had messed up his calculations and set the threshold to 800, and someone had sent in a winning entry, it wouldn't disprove his claims about climate science, it would just mean he hadn't been careful enough in setting up his bet.
