#+TITLE: Compare mrgsolve and Torsten for EVID=4
#+author: Yi Zhang
#+options: toc:nil

* Background
This report summarizes steps to simulate a reset & dose(EVID=4) event
using =mrgsolve= and =Torsten=.

* =Torsten= model
First download the repo with
#+BEGIN_SRC bash
  git clone -b reset_test git@github.com:metrumresearchgroup/Torsten.git
#+END_SRC
Then make the model
#+BEGIN_SRC bash
make -j4 examples/pk2cpt_reset/reset
#+END_SRC
To run the model, do
#+BEGIN_SRC bash
cd examples/pk2cpt_reset/
./reset sample algorithm=fixed_param num_warmup=1 num_samples=1 data file=reset.data.json init=reset.init.R
#+END_SRC
The above run produces deterministic ODE solutions for
a two-compartment PK model based on
parameters in =reset.init.R= and data =reset.data.json=.

One can use =cmdstanr= package in =R= to extract the concentration in central compartment
#+BEGIN_SRC r
  fit <- cmdstanr::read_cmdstan_csv("output.csv", variables=c("cHat"))
  draws <- fit$post_warmup_draws
  torsten.cp <- as.numeric(as.data.frame(draws)[1,])
#+END_SRC

* =mrgsolve= model
#+BEGIN_SRC r
  library("mrgsolve")

  code <- '
  $PARAM CL = 5, Q = 8, V2 = 20, V3 = 70, KA = 1.2

  $CMT GUT CENT PERI

  $GLOBAL
  #define CP (CENT/V2)

  $PKMODEL ncmt = 2, depot = TRUE

  ## $SIGMA 0.01  // variance

  $TABLE
  capture DV = CP * exp(EPS(1));

  $CAPTURE CP
  '

  mod <- mcode("accum", code) %>% Req(CP) %>% update(end=480,delta=0.1)

  data <- rbind(data.frame("time" = 0, "amt" = 10000, "ii" = 24, "addl"=1, cmt=1, evid=1),data.frame("time" = 18, "amt" = 8000, "ii"=0, "addl"=0, cmt=1, evid=4))
  data$ID=1
  mrgsol <- mod %>% data_set(data) %>% mrgsim(end=50)
#+END_SRC

* Compare results
#+BEGIN_SRC r
  ## first we import Torsten's data file
  torsten.data <- jsonlite::read_json("reset.data.json", simplifyVector = TRUE)

  ## plot
  par(mfrow=c(1,2))
  plot(torsten.data$time, torsten.cp, type="l", col="red")
  plot(mrgsol$time, mrgsol$CP, type="l", col="green")
  ## or overlay with
  ## lines(res$time,res$CP,col="green")
#+END_SRC

#+caption: Compare =Torsten= (left) & =mrgsolve= (right) central compartment solution
#+attr_latex: :width \textwidth
[[./reset_compare.png]]
